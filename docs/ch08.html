<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.29">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Kevin Markham">
<meta name="description" content="A practical guide to help you transition from Machine Learning novice to skilled Machine Learning practitioner.">

<title>8&nbsp; Fixing common workflow problems – Master Machine Learning with scikit-learn</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./ch09.html" rel="next">
<link href="./ch07.html" rel="prev">
<link href="./favicon.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-0815c480559380816a4d1ea211a47e91.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-e32d5626311174d9f6538aca58dc36c7.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://cdn.usefathom.com/script.js" data-site="AWKMQOCB" defer=""></script>


<meta property="og:title" content="8&nbsp; Fixing common workflow problems – Master Machine Learning with scikit-learn">
<meta property="og:description" content="A Practical Guide to Building Better Models with Python">
<meta property="og:image" content="https://mlbook.dataschool.io/logo.png">
<meta property="og:site_name" content="Master Machine Learning with scikit-learn">
<meta property="og:image:height" content="141">
<meta property="og:image:width" content="266">
<meta name="twitter:title" content="8&nbsp; Fixing common workflow problems – Master Machine Learning with scikit-learn">
<meta name="twitter:description" content="A Practical Guide to Building Better Models with Python">
<meta name="twitter:image" content="https://mlbook.dataschool.io/logo.png">
<meta name="twitter:image-height" content="141">
<meta name="twitter:image-width" content="266">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./ch08.html"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Fixing common workflow problems</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Master Machine Learning with scikit-learn</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About this book</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Review of the Machine Learning workflow</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Encoding categorical features</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Improving your workflow with ColumnTransformer and Pipeline</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Workflow review #1</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Encoding text data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Handling missing values</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch08.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Fixing common workflow problems</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Workflow review #2</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Evaluating and tuning a Pipeline</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Comparing linear and non-linear models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Ensembling multiple models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch13.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Feature selection</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch14.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Feature standardization</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch15.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Feature engineering with custom transformers</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch16.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Workflow review #3</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch17.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">High-cardinality categorical features</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch18.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Class imbalance</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch19.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Class imbalance walkthrough</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch20.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Going further</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#two-new-problems" id="toc-two-new-problems" class="nav-link active" data-scroll-target="#two-new-problems"><span class="header-section-number">8.1</span> Two new problems</a></li>
  <li><a href="#problem-1-missing-values-in-a-categorical-feature" id="toc-problem-1-missing-values-in-a-categorical-feature" class="nav-link" data-scroll-target="#problem-1-missing-values-in-a-categorical-feature"><span class="header-section-number">8.2</span> Problem 1: Missing values in a categorical feature</a></li>
  <li><a href="#problem-2-missing-values-in-the-new-data" id="toc-problem-2-missing-values-in-the-new-data" class="nav-link" data-scroll-target="#problem-2-missing-values-in-the-new-data"><span class="header-section-number">8.3</span> Problem 2: Missing values in the new data</a></li>
  <li><a href="#sec-8-4" id="toc-sec-8-4" class="nav-link" data-scroll-target="#sec-8-4"><span class="header-section-number">8.4</span> Q&amp;A: How do I see the feature names output by the ColumnTransformer?</a></li>
  <li><a href="#qa-why-did-we-create-a-pipeline-inside-of-the-columntransformer" id="toc-qa-why-did-we-create-a-pipeline-inside-of-the-columntransformer" class="nav-link" data-scroll-target="#qa-why-did-we-create-a-pipeline-inside-of-the-columntransformer"><span class="header-section-number">8.5</span> Q&amp;A: Why did we create a Pipeline inside of the ColumnTransformer?</a></li>
  <li><a href="#qa-which-imputation-strategy-should-i-use-with-categorical-features" id="toc-qa-which-imputation-strategy-should-i-use-with-categorical-features" class="nav-link" data-scroll-target="#qa-which-imputation-strategy-should-i-use-with-categorical-features"><span class="header-section-number">8.6</span> Q&amp;A: Which imputation strategy should I use with categorical features?</a></li>
  <li><a href="#qa-should-i-impute-missing-values-before-all-other-transformations" id="toc-qa-should-i-impute-missing-values-before-all-other-transformations" class="nav-link" data-scroll-target="#qa-should-i-impute-missing-values-before-all-other-transformations"><span class="header-section-number">8.7</span> Q&amp;A: Should I impute missing values before all other transformations?</a></li>
  <li><a href="#qa-what-methods-can-i-use-with-a-pipeline" id="toc-qa-what-methods-can-i-use-with-a-pipeline" class="nav-link" data-scroll-target="#qa-what-methods-can-i-use-with-a-pipeline"><span class="header-section-number">8.8</span> Q&amp;A: What methods can I use with a Pipeline?</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Fixing common workflow problems</span></h1>
<p class="subtitle lead">A Practical Guide to Building Better Models with Python</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="two-new-problems" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="two-new-problems"><span class="header-section-number">8.1</span> Two new problems</h2>
<p>Up to now, we’ve only been working with the first 10 rows of the Titanic dataset to make it easy to examine the input and output of each workflow step. In this chapter, we’ll begin using the full Titanic dataset. This will create a few new problems that are common with real datasets, and we’ll figure out how to handle those problems appropriately.</p>
<p>We’ll start by reading the training data into <code>df</code> and reading the new data into <code>df_new</code>, overwriting the existing objects.</p>
<p>When examining the shapes, you can see that <code>df_new</code> has one less column than df because it doesn’t contain the target column of Survived.</p>
<div id="e7db2734" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">'http://bit.ly/MLtrain'</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>df.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>(891, 11)</code></pre>
</div>
</div>
<div id="567a30fe" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>df_new <span class="op">=</span> pd.read_csv(<span class="st">'http://bit.ly/MLnewdata'</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>df_new.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>(418, 10)</code></pre>
</div>
</div>
<p>We’ll check for missing values in these two DataFrames by chaining together the <code>isna</code> and <code>sum</code> methods. The results tell us how many missing values are present in each column.</p>
<p>This reveals two problems we’ll have to handle that weren’t present in our 10-row datasets. First, Embarked contains missing values in <code>df</code>, and second, Fare contains a missing value in <code>df_new</code>. We’ll spend the rest of this chapter addressing those two problems.</p>
<p>Note that we don’t have to worry about missing values in Cabin because we’re not yet using that as a feature, and our existing workflow already accounts for the missing values in Age.</p>
<div id="fd18e1b0" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>df.isna().<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>Survived      0
Pclass        0
Name          0
Sex           0
Age         177
SibSp         0
Parch         0
Ticket        0
Fare          0
Cabin       687
Embarked      2
dtype: int64</code></pre>
</div>
</div>
<div id="4588d0c6" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>df_new.isna().<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>Pclass        0
Name          0
Sex           0
Age          86
SibSp         0
Parch         0
Ticket        0
Fare          1
Cabin       327
Embarked      0
dtype: int64</code></pre>
</div>
</div>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Features with missing values:</strong></p>
<ul>
<li>Problematic:
<ul>
<li><strong>Embarked:</strong> Missing values in <code>df</code></li>
<li><strong>Fare:</strong> Missing value in <code>df_new</code></li>
</ul></li>
<li>Not problematic:
<ul>
<li><strong>Cabin:</strong> Not currently using</li>
<li><strong>Age:</strong> Already being imputed</li>
</ul></li>
</ul>
</div>
</div>
</div>
</section>
<section id="problem-1-missing-values-in-a-categorical-feature" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="problem-1-missing-values-in-a-categorical-feature"><span class="header-section-number">8.2</span> Problem 1: Missing values in a categorical feature</h2>
<p>In this lesson, we’re going to figure out how to handle the missing values in the Embarked column.</p>
<p>We’ll start with a reminder of the six feature columns we’re using.</p>
<div id="07c2d6c2" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>cols <span class="op">=</span> [<span class="st">'Parch'</span>, <span class="st">'Fare'</span>, <span class="st">'Embarked'</span>, <span class="st">'Sex'</span>, <span class="st">'Name'</span>, <span class="st">'Age'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll redefine <code>X</code> and <code>y</code> to use the full dataset rather than the 10-row dataset.</p>
<div id="31fbab5f" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> df[cols]</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> df[<span class="st">'Survived'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And here’s a reminder of the <code>ColumnTransformer</code> we created in the previous chapter.</p>
<div id="dc245948" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>ct <span class="op">=</span> make_column_transformer(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    (ohe, [<span class="st">'Embarked'</span>, <span class="st">'Sex'</span>]),</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    (vect, <span class="st">'Name'</span>),</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    (imp, [<span class="st">'Age'</span>]),</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'passthrough'</span>, [<span class="st">'Parch'</span>, <span class="st">'Fare'</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Normally we would pass <code>X</code> to the <code>fit_transform</code> method, but in this case it will error because the Embarked column contains missing values. Our solution will be to impute missing values for Embarked before one-hot encoding it.</p>
<div id="2da8c617" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>ct.fit_transform(X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="ab59cab8" class="cell" data-execution_count="10">
<div class="cell-output cell-output-stdout">
<pre><code>ValueError: Input contains NaN</code></pre>
</div>
</div>
<p>As an aside, <code>OneHotEncoder</code> automatically handles missing values by treating them as a new category starting in scikit-learn version 0.24. I’m using version 0.23, and so I’ll be writing the code to manually treat missing values as a new category. Even if you’re using version 0.24 or later, I still recommend following my code because what I’m about to teach you will enable you to solve other similar problems that scikit-learn does not automatically handle.</p>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>How OneHotEncoder handles missing values:</strong></p>
<ul>
<li><strong>Before version 0.24:</strong> Errors if the input contains missing values</li>
<li><strong>Starting in version 0.24:</strong> Treats missing values as a new category</li>
</ul>
</div>
</div>
</div>
<p>As I was saying, our solution is to impute missing values for Embarked and then one-hot encode it.</p>
<p>The first step of this solution is to create a new instance of <code>SimpleImputer</code>, which we’ll call <code>imp_constant</code>. For categorical features, you can either impute the most frequent value or a constant user-defined value. We’ll choose the latter by setting the <code>strategy</code> parameter to <code>'constant'</code>, and the constant value we’ll impute is the string <code>'missing'</code>.</p>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Imputation strategies for categorical features:</strong></p>
<ul>
<li>Most frequent value</li>
<li>User-defined value</li>
</ul>
</div>
</div>
</div>
<div id="dfb36126" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>imp_constant <span class="op">=</span> SimpleImputer(strategy<span class="op">=</span><span class="st">'constant'</span>, fill_value<span class="op">=</span><span class="st">'missing'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we’ll create a two-step <code>Pipeline</code> that only contains transformers. The first step is imputation using our new imputer, and the second step is one-hot encoding. We’ll call this <code>Pipeline</code> <code>imp_ohe</code> to remind us of the two steps it contains.</p>
<div id="3085d946" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>imp_ohe <span class="op">=</span> make_pipeline(imp_constant, ohe)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can test out the <code>imp_ohe</code> <code>Pipeline</code> by passing the Embarked column to its <code>fit_transform</code> method. It outputs four columns because missing values are essentially being treated as a fourth category in addition to C, Q, and S.</p>
<div id="d6e43f3a" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>imp_ohe.fit_transform(X[[<span class="st">'Embarked'</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>&lt;891x4 sparse matrix of type '&lt;class 'numpy.float64'&gt;'
    with 891 stored elements in Compressed Sparse Row format&gt;</code></pre>
</div>
</div>
<p>We can confirm this by accessing the second step of the <code>Pipeline</code>, which is the <code>OneHotEncoder</code>, and then examining the <code>categories_</code> attribute.</p>
<div id="bb3fb6b4" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>imp_ohe[<span class="dv">1</span>].categories_</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>[array(['C', 'Q', 'S', 'missing'], dtype=object)]</code></pre>
</div>
</div>
<p>In case it helps you to understand <code>imp_ohe</code> better, I’m going to show you what happens “under the hood” when you <code>fit_transform</code> this <code>Pipeline</code>. To be clear, you should not actually write the following code, rather it’s just for teaching purposes.</p>
<p>First, the <code>imp_constant</code> object imputes a string value of “missing” for any missing values in the Embarked column. Then, the output of the imputer is one-hot encoded by the <code>ohe</code> object, which outputs four columns.</p>
<div id="347f9ffd" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>ohe.fit_transform(imp_constant.fit_transform(X[[<span class="st">'Embarked'</span>]]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>&lt;891x4 sparse matrix of type '&lt;class 'numpy.float64'&gt;'
    with 891 stored elements in Compressed Sparse Row format&gt;</code></pre>
</div>
</div>
<p>Now that we’ve created a transformer-only <code>Pipeline</code> to handle the missing values in Embarked, we’ll simply replace the <code>ohe</code> transformer in our <code>ColumnTransformer</code> with the <code>imp_ohe</code> <code>Pipeline</code>.</p>
<div id="08b4fbd1" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>ct <span class="op">=</span> make_column_transformer(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    (imp_ohe, [<span class="st">'Embarked'</span>, <span class="st">'Sex'</span>]),</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    (vect, <span class="st">'Name'</span>),</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    (imp, [<span class="st">'Age'</span>]),</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'passthrough'</span>, [<span class="st">'Parch'</span>, <span class="st">'Fare'</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are two things I want to note about the <code>imp_ohe</code> <code>Pipeline</code>:</p>
<ul>
<li>First, you’re only allowed to include transformer objects in a <code>ColumnTransformer</code>, but <code>imp_ohe</code> is eligible because all of its steps are transformers.</li>
<li>Second, it’s completely fine to apply <code>imp_ohe</code> to the Sex column as well as Embarked. There are no missing values in the Sex column, so the imputation step won’t affect it, and it will simply get passed along to the one-hot encoding step.</li>
</ul>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Notes about the imp_ohe Pipeline:</strong></p>
<ul>
<li>Treated like a transformer because all of its steps are transformers</li>
<li>Imputation step won’t affect the Sex column</li>
</ul>
</div>
</div>
</div>
<p>By replacing <code>ohe</code> with <code>imp_ohe</code>, we have now solved the problem of missing values in the Embarked column. Thus, we can pass <code>X</code> to the <code>ColumnTransformer</code>’s <code>fit_transform</code> method, and it will not throw an error.</p>
<p>As an aside, the output matrix is now much wider than before because the Name column of <code>X</code> contains a large number of unique words.</p>
<div id="62218c98" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>ct.fit_transform(X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>&lt;891x1518 sparse matrix of type '&lt;class 'numpy.float64'&gt;'
    with 7328 stored elements in Compressed Sparse Row format&gt;</code></pre>
</div>
</div>
</section>
<section id="problem-2-missing-values-in-the-new-data" class="level2" data-number="8.3">
<h2 data-number="8.3" class="anchored" data-anchor-id="problem-2-missing-values-in-the-new-data"><span class="header-section-number">8.3</span> Problem 2: Missing values in the new data</h2>
<p>Now that we’ve solved our first problem, we’re going to move on to the second problem, which is the missing values in the Fare column. Recall that Fare has missing values in <code>X_new</code> but not in <code>X</code>, and thus our modeling <code>Pipeline</code> would error when making predictions for <code>X_new</code> if we don’t account for these missing values.</p>
<p>Our solution to this problem is to impute missing values for Fare. The <code>ColumnTransformer</code> already contains an imputer that does mean imputation, so we’ll apply the existing imputer to the Fare column, whereas previously Fare was a passthrough column. This is actually all that is required to solve our problem.</p>
<div id="99d10e90" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>ct <span class="op">=</span> make_column_transformer(</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    (imp_ohe, [<span class="st">'Embarked'</span>, <span class="st">'Sex'</span>]),</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    (vect, <span class="st">'Name'</span>),</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    (imp, [<span class="st">'Age'</span>, <span class="st">'Fare'</span>]),</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'passthrough'</span>, [<span class="st">'Parch'</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we’ll pass <code>X</code> to the <code>fit_transform</code> method of the <code>ColumnTransformer</code>. It will output the same number of columns as it did before, since Fare just moved from a passthrough column to a transformed column.</p>
<div id="2ed3afdb" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>ct.fit_transform(X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>&lt;891x1518 sparse matrix of type '&lt;class 'numpy.float64'&gt;'
    with 7328 stored elements in Compressed Sparse Row format&gt;</code></pre>
</div>
</div>
<p>To be clear, the Fare column does not have any missing values in <code>X</code>, thus the imputer did not impute any values for Fare during the <code>fit_transform</code>. However, it did learn the mean of Fare in <code>X</code>, which is the imputation value that will be applied to the Fare column of <code>X_new</code> during prediction.</p>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>What will be imputed for Fare?</strong></p>
<ul>
<li><strong><code>X</code>:</strong> No missing Fare values, thus no imputation of Fare</li>
<li><strong><code>X_new</code>:</strong> Missing Fare value, thus impute the mean of Fare in <code>X</code> during prediction</li>
</ul>
</div>
</div>
</div>
<p>Next, we’ll update our modeling <code>Pipeline</code> to include the revised <code>ColumnTransformer</code>, and fit it on <code>X</code> and <code>y</code>. You can see from the diagram that there’s now a transformer <code>Pipeline</code> within the <code>ColumnTransformer</code>, which is within the modeling <code>Pipeline</code>.</p>
<div id="18f082c6" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>pipe <span class="op">=</span> make_pipeline(ct, logreg)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>pipe.fit(X, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<style>div.sk-top-container {color: black;background-color: white;}div.sk-toggleable {background-color: white;}label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.2em 0.3em;box-sizing: border-box;text-align: center;}div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}div.sk-estimator {font-family: monospace;background-color: #f0f8ff;margin: 0.25em 0.25em;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;}div.sk-estimator:hover {background-color: #d4ebff;}div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 2em;bottom: 0;left: 50%;}div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;}div.sk-item {z-index: 1;}div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;}div.sk-parallel-item {display: flex;flex-direction: column;position: relative;background-color: white;}div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}div.sk-parallel-item:only-child::after {width: 0;}div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0.2em;box-sizing: border-box;padding-bottom: 0.1em;background-color: white;position: relative;}div.sk-label label {font-family: monospace;font-weight: bold;background-color: white;display: inline-block;line-height: 1.2em;}div.sk-label-container {position: relative;z-index: 2;text-align: center;}div.sk-container {display: inline-block;position: relative;}</style><div class="sk-top-container"><div class="sk-container"><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="8da585a7-337a-4d5e-8d40-52e170d307f0" type="checkbox"><label class="sk-toggleable__label" for="8da585a7-337a-4d5e-8d40-52e170d307f0">Pipeline</label><div class="sk-toggleable__content"><pre>Pipeline(steps=[('columntransformer',
                 ColumnTransformer(transformers=[('pipeline',
                                                  Pipeline(steps=[('simpleimputer',
                                                                   SimpleImputer(fill_value='missing',
                                                                                 strategy='constant')),
                                                                  ('onehotencoder',
                                                                   OneHotEncoder())]),
                                                  ['Embarked', 'Sex']),
                                                 ('countvectorizer',
                                                  CountVectorizer(), 'Name'),
                                                 ('simpleimputer',
                                                  SimpleImputer(),
                                                  ['Age', 'Fare']),
                                                 ('passthrough', 'passthrough',
                                                  ['Parch'])])),
                ('logisticregression',
                 LogisticRegression(random_state=1, solver='liblinear'))])</pre></div></div></div><div class="sk-serial"><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="46e2bd83-74cc-46a3-9152-ef5a076a9c18" type="checkbox"><label class="sk-toggleable__label" for="46e2bd83-74cc-46a3-9152-ef5a076a9c18">columntransformer: ColumnTransformer</label><div class="sk-toggleable__content"><pre>ColumnTransformer(transformers=[('pipeline',
                                 Pipeline(steps=[('simpleimputer',
                                                  SimpleImputer(fill_value='missing',
                                                                strategy='constant')),
                                                 ('onehotencoder',
                                                  OneHotEncoder())]),
                                 ['Embarked', 'Sex']),
                                ('countvectorizer', CountVectorizer(), 'Name'),
                                ('simpleimputer', SimpleImputer(),
                                 ['Age', 'Fare']),
                                ('passthrough', 'passthrough', ['Parch'])])</pre></div></div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="f6bf265f-ec53-4d45-b5e1-9220a5a0f793" type="checkbox"><label class="sk-toggleable__label" for="f6bf265f-ec53-4d45-b5e1-9220a5a0f793">pipeline</label><div class="sk-toggleable__content"><pre>['Embarked', 'Sex']</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="bec3e6ec-7e99-44b1-b885-866c8f97824d" type="checkbox"><label class="sk-toggleable__label" for="bec3e6ec-7e99-44b1-b885-866c8f97824d">SimpleImputer</label><div class="sk-toggleable__content"><pre>SimpleImputer(fill_value='missing', strategy='constant')</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="56875946-a125-4c5d-93ee-98e4ecc5c1e7" type="checkbox"><label class="sk-toggleable__label" for="56875946-a125-4c5d-93ee-98e4ecc5c1e7">OneHotEncoder</label><div class="sk-toggleable__content"><pre>OneHotEncoder()</pre></div></div></div></div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="040aa5db-f6dd-4a44-b500-bec7306d72c1" type="checkbox"><label class="sk-toggleable__label" for="040aa5db-f6dd-4a44-b500-bec7306d72c1">countvectorizer</label><div class="sk-toggleable__content"><pre>Name</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="f2f57416-021b-4303-be0b-0cf6e768957d" type="checkbox"><label class="sk-toggleable__label" for="f2f57416-021b-4303-be0b-0cf6e768957d">CountVectorizer</label><div class="sk-toggleable__content"><pre>CountVectorizer()</pre></div></div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="fca4c708-ae8f-4b8c-8311-00729036d47d" type="checkbox"><label class="sk-toggleable__label" for="fca4c708-ae8f-4b8c-8311-00729036d47d">simpleimputer</label><div class="sk-toggleable__content"><pre>['Age', 'Fare']</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="cd51ee0a-1364-4e75-9d0f-1dcb9c43b3df" type="checkbox"><label class="sk-toggleable__label" for="cd51ee0a-1364-4e75-9d0f-1dcb9c43b3df">SimpleImputer</label><div class="sk-toggleable__content"><pre>SimpleImputer()</pre></div></div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="432b8d52-6858-4e1c-99fb-98cb7a34aa9d" type="checkbox"><label class="sk-toggleable__label" for="432b8d52-6858-4e1c-99fb-98cb7a34aa9d">passthrough</label><div class="sk-toggleable__content"><pre>['Parch']</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="f94a9764-4629-4cd9-83e6-2f0fcb7d842c" type="checkbox"><label class="sk-toggleable__label" for="f94a9764-4629-4cd9-83e6-2f0fcb7d842c">passthrough</label><div class="sk-toggleable__content"><pre>passthrough</pre></div></div></div></div></div></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="6abad70d-4f8e-4521-bcaf-c72a92fa486b" type="checkbox"><label class="sk-toggleable__label" for="6abad70d-4f8e-4521-bcaf-c72a92fa486b">LogisticRegression</label><div class="sk-toggleable__content"><pre>LogisticRegression(random_state=1, solver='liblinear')</pre></div></div></div></div></div></div></div>
</div>
</div>
<p>Finally, we’ll redefine <code>X_new</code> to use the full dataset, and then use the fitted <code>Pipeline</code> to make predictions for <code>X_new</code>. We know that we’ve solved our second problem because the <code>Pipeline</code> did not throw any errors during the predict step.</p>
<div id="919481e8" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>X_new <span class="op">=</span> df_new[cols]</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>pipe.predict(X_new)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>array([0, 1, 0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 1, 0, 1, 1, 0, 0, 0, 1, 0, 1,
       1, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1,
       1, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 1, 1,
       1, 0, 0, 1, 1, 0, 1, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 0, 0, 1, 1,
       1, 1, 1, 0, 1, 0, 0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0,
       0, 1, 1, 1, 1, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 1, 0, 1, 0, 0, 0, 0,
       0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0,
       1, 0, 1, 1, 0, 1, 1, 1, 1, 0, 0, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1,
       1, 0, 1, 1, 0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1,
       0, 1, 1, 0, 1, 1, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1, 0, 0, 1, 0, 1, 0,
       1, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1,
       1, 0, 0, 0, 1, 0, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 1,
       0, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 1, 0, 0, 0, 0, 1, 0, 1, 1, 1, 0,
       0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 1,
       0, 1, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0,
       1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0, 1, 0, 1, 1, 0,
       0, 0, 1, 0, 1, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0, 0,
       1, 1, 1, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1,
       0, 1, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 0, 0, 1])</code></pre>
</div>
</div>
</section>
<section id="sec-8-4" class="level2" data-number="8.4">
<h2 data-number="8.4" class="anchored" data-anchor-id="sec-8-4"><span class="header-section-number">8.4</span> Q&amp;A: How do I see the feature names output by the ColumnTransformer?</h2>
<p>When we pass <code>X</code> to the <code>ColumnTransformer</code>’s <code>fit_transform</code> method, it outputs a matrix with 1518 columns. How can we find out the names of these columns?</p>
<div id="fb957691" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>ct.fit_transform(X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>&lt;891x1518 sparse matrix of type '&lt;class 'numpy.float64'&gt;'
    with 7328 stored elements in Compressed Sparse Row format&gt;</code></pre>
</div>
</div>
<p>Earlier in the book, we used the <code>get_feature_names</code> method for this purpose, which, as I mentioned previously, has been replaced by <code>get_feature_names_out</code> starting in scikit-learn 1.0. However, <code>get_feature_names</code> will only work if all of the underlying transformers have a <code>get_feature_names</code> method. In this case, it errors because neither <code>Pipeline</code> transformers nor <code>SimpleImputer</code> transformers have a <code>get_feature_names</code> method.</p>
<div id="bd01450a" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>ct.get_feature_names()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="53269962" class="cell" data-execution_count="25">
<div class="cell-output cell-output-stdout">
<pre><code>AttributeError: Transformer pipeline does not provide get_feature_names</code></pre>
</div>
</div>
<p>The good news is that starting in scikit-learn 1.1, the <code>get_feature_names_out</code> method is available for all transformers, which means that retrieving the feature names will no longer error.</p>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Changes to get_feature_names:</strong></p>
<ul>
<li><strong>Starting in version 1.0:</strong> <code>get_feature_names</code> replaced with <code>get_feature_names_out</code></li>
<li><strong>Starting in version 1.1:</strong> <code>get_feature_names_out</code> available for all transformers</li>
</ul>
</div>
</div>
</div>
<p>In the meantime, our only solution for figuring out the column names is to inspect the transformers one-by-one.</p>
<p>When we print out the <code>transformers_</code> attribute, we can see that there are 4 transformers.</p>
<div id="24d8ef32" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>ct.transformers_</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>[('pipeline',
  Pipeline(steps=[('simpleimputer',
                   SimpleImputer(fill_value='missing', strategy='constant')),
                  ('onehotencoder', OneHotEncoder())]),
  ['Embarked', 'Sex']),
 ('countvectorizer', CountVectorizer(), 'Name'),
 ('simpleimputer', SimpleImputer(), ['Age', 'Fare']),
 ('passthrough', 'passthrough', ['Parch'])]</code></pre>
</div>
</div>
<p>The first transformer is a <code>Pipeline</code> of <code>SimpleImputer</code> and <code>OneHotEncoder</code>. <code>OneHotEncoder</code> has a <code>get_feature_names</code> method, which we can access by selecting the <code>pipeline</code> transformer and then its <code>onehotencoder</code> step. <code>get_feature_names</code> outputs 6 features, which we know are the first 6 features in the matrix because this is the first transformer in the <code>ColumnTransformer</code>.</p>
<div id="569a0d7c" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>(ct.named_transformers_[<span class="st">'pipeline'</span>]</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>   .named_steps[<span class="st">'onehotencoder'</span>]</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>   .get_feature_names())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>array(['x0_C', 'x0_Q', 'x0_S', 'x0_missing', 'x1_female', 'x1_male'],
      dtype=object)</code></pre>
</div>
</div>
<p>The second transformer is a <code>CountVectorizer</code>. It also has a <code>get_feature_names</code> method, which we can access by selecting the <code>countvectorizer</code> transformer. We could print out all of the feature names, but instead we’ll pass it to the <code>len</code> function, which indicates that the next 1509 features in the matrix came from <code>CountVectorizer</code>.</p>
<div id="403a64d7" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(ct.named_transformers_[<span class="st">'countvectorizer'</span>].get_feature_names())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>1509</code></pre>
</div>
</div>
<p>The third transformer is a <code>SimpleImputer</code>, which doesn’t change the number of columns since we’re not adding a missing indicator, so we know that the next two features in the matrix are Age and Fare.</p>
<p>The fourth transformer is a passthrough transformer, which also doesn’t change the number of columns, so we know that the final feature in the matrix is Parch.</p>
<p>We’ve now accounted for all 1518 features: 6 from the <code>Pipeline</code> transformer, 1509 from the <code>CountVectorizer</code>, 2 from the <code>SimpleImputer</code>, and 1 from the passthrough transformer.</p>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Features output by each transformer:</strong></p>
<ul>
<li><strong><code>Pipeline</code>:</strong> 6 features (Embarked and Sex)</li>
<li><strong><code>CountVectorizer</code>:</strong> 1509 features (Name)</li>
<li><strong><code>SimpleImputer</code>:</strong> 2 features (Age and Fare)</li>
<li><strong>passthrough:</strong> 1 feature (Parch)</li>
</ul>
</div>
</div>
</div>
</section>
<section id="qa-why-did-we-create-a-pipeline-inside-of-the-columntransformer" class="level2" data-number="8.5">
<h2 data-number="8.5" class="anchored" data-anchor-id="qa-why-did-we-create-a-pipeline-inside-of-the-columntransformer"><span class="header-section-number">8.5</span> Q&amp;A: Why did we create a Pipeline inside of the ColumnTransformer?</h2>
<p>Earlier in this chapter, since the Embarked column contained missing values and needed one-hot encoding, we created a two-step <code>Pipeline</code> called <code>imp_ohe</code>. The first step of this <code>Pipeline</code> is imputation of a constant value, and the second step is one-hot encoding.</p>
<div id="89df58c3" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>imp_ohe <span class="op">=</span> make_pipeline(imp_constant, ohe)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We included the <code>imp_ohe</code> <code>Pipeline</code> in the <code>ColumnTransformer</code>, and applied it to both the Embarked and Sex columns. Here’s what it would look like if the <code>ColumnTransformer</code> only contained the <code>imp_ohe</code> <code>Pipeline</code>.</p>
<div id="fab792c4" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>ct <span class="op">=</span> make_column_transformer(</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    (imp_ohe, [<span class="st">'Embarked'</span>, <span class="st">'Sex'</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When you run the <code>fit_transform</code> method, Embarked turns into 4 columns and Sex turns into 2 columns, and the results are stacked side-by-side.</p>
<div id="b6f44f7c" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>ct.fit_transform(X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>array([[0., 0., 1., 0., 0., 1.],
       [1., 0., 0., 0., 1., 0.],
       [0., 0., 1., 0., 1., 0.],
       ...,
       [0., 0., 1., 0., 1., 0.],
       [1., 0., 0., 0., 0., 1.],
       [0., 1., 0., 0., 0., 1.]])</code></pre>
</div>
</div>
<p>Because the Sex column didn’t contain any missing values and only needed one-hot encoding, we could have achieved the exact same results by applying <code>imp_ohe</code> just to Embarked and then separately applying <code>ohe</code> to Sex.</p>
<div id="659724c4" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>ct <span class="op">=</span> make_column_transformer(</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    (imp_ohe, [<span class="st">'Embarked'</span>]),</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    (ohe, [<span class="st">'Sex'</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>fit_transform</code> does indeed output the same results as above, though I personally prefer the first <code>ColumnTransformer</code>.</p>
<div id="a8e76227" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>ct.fit_transform(X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>array([[0., 0., 1., 0., 0., 1.],
       [1., 0., 0., 0., 1., 0.],
       [0., 0., 1., 0., 1., 0.],
       ...,
       [0., 0., 1., 0., 1., 0.],
       [1., 0., 0., 0., 0., 1.],
       [0., 1., 0., 0., 0., 1.]])</code></pre>
</div>
</div>
<p>One common question is whether you can avoid using the <code>imp_ohe</code> <code>Pipeline</code> entirely by making a <code>ColumnTransformer</code> like this instead, in which the imputation of a constant value is applied to Embarked, and one-hot encoding is applied to both Embarked and Sex.</p>
<div id="7e136c0a" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>ct <span class="op">=</span> make_column_transformer(</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    (imp_constant, [<span class="st">'Embarked'</span>]),</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    (ohe, [<span class="st">'Embarked'</span>, <span class="st">'Sex'</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The answer is no, you cannot. The <code>fit_transform</code> method throws an error because Embarked contains missing values, and the <code>ohe</code> transformer is not able to handle missing values.</p>
<div id="65601b21" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>ct.fit_transform(X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="063d4f4d" class="cell" data-execution_count="36">
<div class="cell-output cell-output-stdout">
<pre><code>ValueError: Input contains NaN</code></pre>
</div>
</div>
<p>The key insight here is that there’s no interaction between the transformers of a <code>ColumnTransformer</code>. In other words, there’s no flow of data from one transformer to the next, meaning the output of the <code>imp_constant</code> transformer does not become the input to the <code>ohe</code> transformer. Thus, the <code>ohe</code> transformer is operating on the original Embarked column, not a transformed Embarked column in which missing values have been imputed.</p>
<p>If that’s confusing, it might be useful to recall the key differences between a <code>Pipeline</code> and a <code>ColumnTransformer</code>:</p>
<ul>
<li>In a <code>Pipeline</code>, the output of one step becomes the input to the next step. This is precisely why we created the <code>imp_ohe</code> <code>Pipeline</code>: We needed the output of the imputer to become the input to the ohe-hot encoder.</li>
<li>In contrast, a <code>ColumnTransformer</code> does not have steps. Instead, it has transformers that operate in parallel, and the output of each transformer is stacked beside the other transformer outputs.</li>
</ul>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Pipeline vs ColumnTransformer:</strong></p>
<ul>
<li><strong><code>Pipeline</code>:</strong>
<ul>
<li>Output of one step becomes the input to the next step</li>
<li><strong><code>imp_ohe</code>:</strong> Output of <code>imp_constant</code> becomes the input to <code>ohe</code></li>
</ul></li>
<li><strong><code>ColumnTransformer</code>:</strong>
<ul>
<li>Transformers operate in parallel</li>
<li><strong><code>ct</code>:</strong> Output of each transformer is stacked beside the other transformer outputs</li>
</ul></li>
</ul>
</div>
</div>
</div>
</section>
<section id="qa-which-imputation-strategy-should-i-use-with-categorical-features" class="level2" data-number="8.6">
<h2 data-number="8.6" class="anchored" data-anchor-id="qa-which-imputation-strategy-should-i-use-with-categorical-features"><span class="header-section-number">8.6</span> Q&amp;A: Which imputation strategy should I use with categorical features?</h2>
<p>When imputing missing values for a categorical feature, you can either impute the most frequent value or a constant user-defined value. In this lesson, I’m going to discuss how you might choose between these two strategies.</p>
<p>Imputing a constant value essentially treats the missing values as a new category, which I believe is the better choice regardless of whether the values are missing at random or not at random. Imputing a constant value is especially important if the majority of values are missing, since imputing the most frequent value in that case would more than double the size of the category that was imputed, which would be quite misleading to the model.</p>
<p>That being said, imputing the most frequent value is much more acceptable when you have only a small number of missing values for a given feature, since the imputation won’t have much of an impact on the model anyway.</p>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Imputation strategies for categorical features:</strong></p>
<ul>
<li><strong>Constant user-defined value:</strong>
<ul>
<li>Treats missing values as a new category (recommended)</li>
<li>Important if the majority of values are missing</li>
</ul></li>
<li><strong>Most frequent value:</strong>
<ul>
<li>Acceptable if only a small number of values are missing</li>
</ul></li>
</ul>
</div>
</div>
</div>
<p>It’s important to note that if you impute a constant value for a feature, and that feature has missing values in the new data but not the training data, then you’ll need to set the <code>OneHotEncoder</code>’s <code>handle_unknown</code> parameter to <code>'ignore'</code>. That’s because the missing values category won’t be learned during the <code>OneHotEncoder</code>’s fit step, and thus unknown values seen during the transform step need to be ignored in order to avoid an error.</p>
<p>The alternative here is just to impute the most frequent value for that feature, in which case you can leave the <code>handle_unknown</code> parameter set to its default value of <code>'error'</code>.</p>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Possible problem with imputing a constant value:</strong></p>
<ul>
<li><strong>Condition:</strong> The feature only has missing values in the new data</li>
<li><strong>Solution:</strong> Set <code>handle_unknown</code> to <code>'ignore'</code> for the <code>OneHotEncoder</code></li>
<li><strong>Alternative:</strong> Impute the most frequent value, and leave <code>handle_unknown</code> set to <code>'error'</code></li>
</ul>
</div>
</div>
</div>
</section>
<section id="qa-should-i-impute-missing-values-before-all-other-transformations" class="level2" data-number="8.7">
<h2 data-number="8.7" class="anchored" data-anchor-id="qa-should-i-impute-missing-values-before-all-other-transformations"><span class="header-section-number">8.7</span> Q&amp;A: Should I impute missing values before all other transformations?</h2>
<p>Here’s the <code>Pipeline</code> that we’ve built throughout the book. The strategy I’ve used throughout is to include all data transformations within a single <code>ColumnTransformer</code>, including any missing value imputation, and then use that <code>ColumnTransformer</code> as the first step in a two-step <code>Pipeline</code>.</p>
<div id="b5ca4b70" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>pipe</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<style>div.sk-top-container {color: black;background-color: white;}div.sk-toggleable {background-color: white;}label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.2em 0.3em;box-sizing: border-box;text-align: center;}div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}div.sk-estimator {font-family: monospace;background-color: #f0f8ff;margin: 0.25em 0.25em;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;}div.sk-estimator:hover {background-color: #d4ebff;}div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 2em;bottom: 0;left: 50%;}div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;}div.sk-item {z-index: 1;}div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;}div.sk-parallel-item {display: flex;flex-direction: column;position: relative;background-color: white;}div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}div.sk-parallel-item:only-child::after {width: 0;}div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0.2em;box-sizing: border-box;padding-bottom: 0.1em;background-color: white;position: relative;}div.sk-label label {font-family: monospace;font-weight: bold;background-color: white;display: inline-block;line-height: 1.2em;}div.sk-label-container {position: relative;z-index: 2;text-align: center;}div.sk-container {display: inline-block;position: relative;}</style><div class="sk-top-container"><div class="sk-container"><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="f564abae-525f-4345-a8b0-34a367fc57a3" type="checkbox"><label class="sk-toggleable__label" for="f564abae-525f-4345-a8b0-34a367fc57a3">Pipeline</label><div class="sk-toggleable__content"><pre>Pipeline(steps=[('columntransformer',
                 ColumnTransformer(transformers=[('pipeline',
                                                  Pipeline(steps=[('simpleimputer',
                                                                   SimpleImputer(fill_value='missing',
                                                                                 strategy='constant')),
                                                                  ('onehotencoder',
                                                                   OneHotEncoder())]),
                                                  ['Embarked', 'Sex']),
                                                 ('countvectorizer',
                                                  CountVectorizer(), 'Name'),
                                                 ('simpleimputer',
                                                  SimpleImputer(),
                                                  ['Age', 'Fare']),
                                                 ('passthrough', 'passthrough',
                                                  ['Parch'])])),
                ('logisticregression',
                 LogisticRegression(random_state=1, solver='liblinear'))])</pre></div></div></div><div class="sk-serial"><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="216f4d4d-81f9-47f4-ba83-d85bead86348" type="checkbox"><label class="sk-toggleable__label" for="216f4d4d-81f9-47f4-ba83-d85bead86348">columntransformer: ColumnTransformer</label><div class="sk-toggleable__content"><pre>ColumnTransformer(transformers=[('pipeline',
                                 Pipeline(steps=[('simpleimputer',
                                                  SimpleImputer(fill_value='missing',
                                                                strategy='constant')),
                                                 ('onehotencoder',
                                                  OneHotEncoder())]),
                                 ['Embarked', 'Sex']),
                                ('countvectorizer', CountVectorizer(), 'Name'),
                                ('simpleimputer', SimpleImputer(),
                                 ['Age', 'Fare']),
                                ('passthrough', 'passthrough', ['Parch'])])</pre></div></div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="922a0071-cd44-4813-bab2-f0ea5b0b79fd" type="checkbox"><label class="sk-toggleable__label" for="922a0071-cd44-4813-bab2-f0ea5b0b79fd">pipeline</label><div class="sk-toggleable__content"><pre>['Embarked', 'Sex']</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="b28f1e88-b467-41ac-bd79-7590deb9300b" type="checkbox"><label class="sk-toggleable__label" for="b28f1e88-b467-41ac-bd79-7590deb9300b">SimpleImputer</label><div class="sk-toggleable__content"><pre>SimpleImputer(fill_value='missing', strategy='constant')</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="a89b9996-ced9-449d-8d99-60de8570d102" type="checkbox"><label class="sk-toggleable__label" for="a89b9996-ced9-449d-8d99-60de8570d102">OneHotEncoder</label><div class="sk-toggleable__content"><pre>OneHotEncoder()</pre></div></div></div></div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="7c9547f2-9e62-463b-86da-712061d8e342" type="checkbox"><label class="sk-toggleable__label" for="7c9547f2-9e62-463b-86da-712061d8e342">countvectorizer</label><div class="sk-toggleable__content"><pre>Name</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="4ebdd6d8-ac38-4a33-8ebb-abae46b92a5e" type="checkbox"><label class="sk-toggleable__label" for="4ebdd6d8-ac38-4a33-8ebb-abae46b92a5e">CountVectorizer</label><div class="sk-toggleable__content"><pre>CountVectorizer()</pre></div></div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="8cfc7f32-b579-4f08-b05e-a09d16b9ceb6" type="checkbox"><label class="sk-toggleable__label" for="8cfc7f32-b579-4f08-b05e-a09d16b9ceb6">simpleimputer</label><div class="sk-toggleable__content"><pre>['Age', 'Fare']</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="6d316d12-6c96-4d34-9f55-a69fb403ae28" type="checkbox"><label class="sk-toggleable__label" for="6d316d12-6c96-4d34-9f55-a69fb403ae28">SimpleImputer</label><div class="sk-toggleable__content"><pre>SimpleImputer()</pre></div></div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="e8df779e-1724-4e90-8f17-f7525048d8f6" type="checkbox"><label class="sk-toggleable__label" for="e8df779e-1724-4e90-8f17-f7525048d8f6">passthrough</label><div class="sk-toggleable__content"><pre>['Parch']</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="df328f80-1398-4e71-addf-e6b9ae8e0788" type="checkbox"><label class="sk-toggleable__label" for="df328f80-1398-4e71-addf-e6b9ae8e0788">passthrough</label><div class="sk-toggleable__content"><pre>passthrough</pre></div></div></div></div></div></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="20d045ab-9b02-40a8-b555-ac396971744b" type="checkbox"><label class="sk-toggleable__label" for="20d045ab-9b02-40a8-b555-ac396971744b">LogisticRegression</label><div class="sk-toggleable__content"><pre>LogisticRegression(random_state=1, solver='liblinear')</pre></div></div></div></div></div></div></div>
</div>
</div>
<p>However, an alternative approach would to create a three-step <code>Pipeline</code> in which the first step is missing value imputation, the second step includes all other data transformations, and the third step is the model. Let’s try it out to see if this is a better approach.</p>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Impute missing values as a first step?</strong></p>
<ul>
<li><strong>Current <code>Pipeline</code>:</strong>
<ul>
<li><strong>Step 1:</strong> All data transformations</li>
<li><strong>Step 2:</strong> Model</li>
</ul></li>
<li><strong>Alternative <code>Pipeline</code>:</strong>
<ul>
<li><strong>Step 1:</strong> Missing value imputation</li>
<li><strong>Step 2:</strong> All other data transformations</li>
<li><strong>Step 3:</strong> Model</li>
</ul></li>
</ul>
</div>
</div>
</div>
<p>This would be the first <code>ColumnTransformer</code>, which only does missing value imputation. Constant value imputation is applied to Embarked, mean imputation is applied to Age and Fare, and the other columns are passed through because they don’t contain any missing values in the training or new data. It would be the first step in the <code>Pipeline</code>.</p>
<div id="b913a6c7" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>ct1 <span class="op">=</span> make_column_transformer(</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    (imp_constant, [<span class="st">'Embarked'</span>]),</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    (imp, [<span class="st">'Age'</span>, <span class="st">'Fare'</span>]),</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'passthrough'</span>, [<span class="st">'Sex'</span>, <span class="st">'Name'</span>, <span class="st">'Parch'</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This would be the second <code>ColumnTransformer</code>, which handles all other data transformations. It would be the second step in the <code>Pipeline</code>, and thus it would operate on the output of the first <code>ColumnTransformer</code>. However, a <code>ColumnTransformer</code> outputs a NumPy array, not a DataFrame, and thus in this <code>ColumnTransformer</code> we would have to reference the columns by position instead of by name.</p>
<p>We know the order of the columns from the first <code>ColumnTransformer</code>, and thus Embarked and Sex would be columns 0 and 3 and Name would be column 4. Embarked and Sex are one-hot encoded, Name is vectorized, and the other columns are passed through.</p>
<div id="e626e45a" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>ct2 <span class="op">=</span> make_column_transformer(</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    (ohe, [<span class="dv">0</span>, <span class="dv">3</span>]),</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    (vect, <span class="dv">4</span>),</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'passthrough'</span>, [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">5</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we’ve created the <code>ColumnTransformers</code>, we can include them in a three-step <code>Pipeline</code> and <code>fit</code> the <code>Pipeline</code> to <code>X</code> and <code>y</code>.</p>
<div id="056d1e2f" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>pipe <span class="op">=</span> make_pipeline(ct1, ct2, logreg)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>pipe.fit(X, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<style>div.sk-top-container {color: black;background-color: white;}div.sk-toggleable {background-color: white;}label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.2em 0.3em;box-sizing: border-box;text-align: center;}div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}div.sk-estimator {font-family: monospace;background-color: #f0f8ff;margin: 0.25em 0.25em;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;}div.sk-estimator:hover {background-color: #d4ebff;}div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 2em;bottom: 0;left: 50%;}div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;}div.sk-item {z-index: 1;}div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;}div.sk-parallel-item {display: flex;flex-direction: column;position: relative;background-color: white;}div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}div.sk-parallel-item:only-child::after {width: 0;}div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0.2em;box-sizing: border-box;padding-bottom: 0.1em;background-color: white;position: relative;}div.sk-label label {font-family: monospace;font-weight: bold;background-color: white;display: inline-block;line-height: 1.2em;}div.sk-label-container {position: relative;z-index: 2;text-align: center;}div.sk-container {display: inline-block;position: relative;}</style><div class="sk-top-container"><div class="sk-container"><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="cf2d9a98-0c67-47fe-ab2a-40342df6cea0" type="checkbox"><label class="sk-toggleable__label" for="cf2d9a98-0c67-47fe-ab2a-40342df6cea0">Pipeline</label><div class="sk-toggleable__content"><pre>Pipeline(steps=[('columntransformer-1',
                 ColumnTransformer(transformers=[('simpleimputer-1',
                                                  SimpleImputer(fill_value='missing',
                                                                strategy='constant'),
                                                  ['Embarked']),
                                                 ('simpleimputer-2',
                                                  SimpleImputer(),
                                                  ['Age', 'Fare']),
                                                 ('passthrough', 'passthrough',
                                                  ['Sex', 'Name', 'Parch'])])),
                ('columntransformer-2',
                 ColumnTransformer(transformers=[('onehotencoder',
                                                  OneHotEncoder(), [0, 3]),
                                                 ('countvectorizer',
                                                  CountVectorizer(), 4),
                                                 ('passthrough', 'passthrough',
                                                  [1, 2, 5])])),
                ('logisticregression',
                 LogisticRegression(random_state=1, solver='liblinear'))])</pre></div></div></div><div class="sk-serial"><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="64739276-cd3a-4d3a-963b-bcbaaca92540" type="checkbox"><label class="sk-toggleable__label" for="64739276-cd3a-4d3a-963b-bcbaaca92540">columntransformer-1: ColumnTransformer</label><div class="sk-toggleable__content"><pre>ColumnTransformer(transformers=[('simpleimputer-1',
                                 SimpleImputer(fill_value='missing',
                                               strategy='constant'),
                                 ['Embarked']),
                                ('simpleimputer-2', SimpleImputer(),
                                 ['Age', 'Fare']),
                                ('passthrough', 'passthrough',
                                 ['Sex', 'Name', 'Parch'])])</pre></div></div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="e1ebb3bc-4e38-4976-b4ce-9a95202e1054" type="checkbox"><label class="sk-toggleable__label" for="e1ebb3bc-4e38-4976-b4ce-9a95202e1054">simpleimputer-1</label><div class="sk-toggleable__content"><pre>['Embarked']</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="10ff9f06-c651-4bd0-b743-b6db31825a79" type="checkbox"><label class="sk-toggleable__label" for="10ff9f06-c651-4bd0-b743-b6db31825a79">SimpleImputer</label><div class="sk-toggleable__content"><pre>SimpleImputer(fill_value='missing', strategy='constant')</pre></div></div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="5ae1b8f9-2dee-441b-bf19-d4ed07f036e3" type="checkbox"><label class="sk-toggleable__label" for="5ae1b8f9-2dee-441b-bf19-d4ed07f036e3">simpleimputer-2</label><div class="sk-toggleable__content"><pre>['Age', 'Fare']</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="df68ff2c-2c2e-4916-8ba9-bc4383230418" type="checkbox"><label class="sk-toggleable__label" for="df68ff2c-2c2e-4916-8ba9-bc4383230418">SimpleImputer</label><div class="sk-toggleable__content"><pre>SimpleImputer()</pre></div></div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="81d67a1d-3f00-4ab7-95d5-158b0403ee1a" type="checkbox"><label class="sk-toggleable__label" for="81d67a1d-3f00-4ab7-95d5-158b0403ee1a">passthrough</label><div class="sk-toggleable__content"><pre>['Sex', 'Name', 'Parch']</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="169159bc-d244-4b56-b8c2-d680a511b2bb" type="checkbox"><label class="sk-toggleable__label" for="169159bc-d244-4b56-b8c2-d680a511b2bb">passthrough</label><div class="sk-toggleable__content"><pre>passthrough</pre></div></div></div></div></div></div></div></div><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="206dbce2-95d9-480c-8903-ddc6e3ec49e9" type="checkbox"><label class="sk-toggleable__label" for="206dbce2-95d9-480c-8903-ddc6e3ec49e9">columntransformer-2: ColumnTransformer</label><div class="sk-toggleable__content"><pre>ColumnTransformer(transformers=[('onehotencoder', OneHotEncoder(), [0, 3]),
                                ('countvectorizer', CountVectorizer(), 4),
                                ('passthrough', 'passthrough', [1, 2, 5])])</pre></div></div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="9d6f1b7d-b173-4a1d-bfc4-402929bf1adf" type="checkbox"><label class="sk-toggleable__label" for="9d6f1b7d-b173-4a1d-bfc4-402929bf1adf">onehotencoder</label><div class="sk-toggleable__content"><pre>[0, 3]</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="c0013b42-b745-42de-a073-1a2fd7078669" type="checkbox"><label class="sk-toggleable__label" for="c0013b42-b745-42de-a073-1a2fd7078669">OneHotEncoder</label><div class="sk-toggleable__content"><pre>OneHotEncoder()</pre></div></div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="9f689185-a6cb-4e99-be31-dc3b632fb434" type="checkbox"><label class="sk-toggleable__label" for="9f689185-a6cb-4e99-be31-dc3b632fb434">countvectorizer</label><div class="sk-toggleable__content"><pre>4</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="1af7bdba-25ac-44ea-aa08-4baa35df52e4" type="checkbox"><label class="sk-toggleable__label" for="1af7bdba-25ac-44ea-aa08-4baa35df52e4">CountVectorizer</label><div class="sk-toggleable__content"><pre>CountVectorizer()</pre></div></div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="130860ba-c2c2-4faf-a35d-5bc4697b07d8" type="checkbox"><label class="sk-toggleable__label" for="130860ba-c2c2-4faf-a35d-5bc4697b07d8">passthrough</label><div class="sk-toggleable__content"><pre>[1, 2, 5]</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="772f5a84-3c88-4616-8805-1f227eed250a" type="checkbox"><label class="sk-toggleable__label" for="772f5a84-3c88-4616-8805-1f227eed250a">passthrough</label><div class="sk-toggleable__content"><pre>passthrough</pre></div></div></div></div></div></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="7852530b-2cfe-44c1-bca9-9a81c42df961" type="checkbox"><label class="sk-toggleable__label" for="7852530b-2cfe-44c1-bca9-9a81c42df961">LogisticRegression</label><div class="sk-toggleable__content"><pre>LogisticRegression(random_state=1, solver='liblinear')</pre></div></div></div></div></div></div></div>
</div>
</div>
<p>Finally, we can use this three-step <code>Pipeline</code> to make predictions, and it does indeed make the same predictions as our original two-step <code>Pipeline</code>.</p>
<div id="86ea77b9" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>pipe.predict(X_new)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>array([0, 1, 0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 1, 0, 1, 1, 0, 0, 0, 1, 0, 1,
       1, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1,
       1, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 1, 1,
       1, 0, 0, 1, 1, 0, 1, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 0, 0, 1, 1,
       1, 1, 1, 0, 1, 0, 0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0,
       0, 1, 1, 1, 1, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 1, 0, 1, 0, 0, 0, 0,
       0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0,
       1, 0, 1, 1, 0, 1, 1, 1, 1, 0, 0, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1,
       1, 0, 1, 1, 0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1,
       0, 1, 1, 0, 1, 1, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1, 0, 0, 1, 0, 1, 0,
       1, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1,
       1, 0, 0, 0, 1, 0, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 1,
       0, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 1, 0, 0, 0, 0, 1, 0, 1, 1, 1, 0,
       0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 1,
       0, 1, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0,
       1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0, 1, 0, 1, 1, 0,
       0, 0, 1, 0, 1, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0, 0,
       1, 1, 1, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1,
       0, 1, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 0, 0, 1])</code></pre>
</div>
</div>
<p>Using a three-step <code>Pipeline</code> like this is certainly a valid approach. However, I find the original two-step <code>Pipeline</code> easier to write and to read, and thus I prefer the two-step approach.</p>
</section>
<section id="qa-what-methods-can-i-use-with-a-pipeline" class="level2" data-number="8.8">
<h2 data-number="8.8" class="anchored" data-anchor-id="qa-what-methods-can-i-use-with-a-pipeline"><span class="header-section-number">8.8</span> Q&amp;A: What methods can I use with a Pipeline?</h2>
<p>The rules for <code>Pipeline</code>s are that all steps other than the final step must be a transformer, and the final step can be a model or a transformer.</p>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Rules for Pipeline steps:</strong></p>
<ul>
<li>All steps other than the final step must be a transformer</li>
<li>Final step can be a model or a transformer</li>
</ul>
</div>
</div>
</div>
<p>If a <code>Pipeline</code> ends in a model, such as our <code>pipe</code> object, you can use the <code>Pipeline</code>’s <code>fit</code> and <code>predict</code> methods:</p>
<ul>
<li>If you run the <code>fit</code> method, all steps before the final one run <code>fit_transform</code>, and the final step runs <code>fit</code>.</li>
<li>If you run the <code>predict</code> method, all steps before the final one run <code>transform</code>, and the final step runs <code>predict</code>.</li>
</ul>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Pipeline ends in a model:</strong></p>
<ul>
<li><strong><code>fit</code>:</strong>
<ul>
<li>All steps before the final step run <code>fit_transform</code></li>
<li>Final step runs <code>fit</code></li>
</ul></li>
<li><strong><code>predict</code>:</strong>
<ul>
<li>All steps before the final step run <code>transform</code></li>
<li>Final step runs <code>predict</code></li>
</ul></li>
</ul>
</div>
</div>
</div>
<p>If a <code>Pipeline</code> ends in a transformer, such as our <code>imp_ohe</code> object, you generally use the <code>Pipeline</code>’s <code>fit_transform</code> and <code>transform</code> methods, but you can also use the <code>fit</code> method:</p>
<ul>
<li>If you run the <code>fit_transform</code> method, all steps run <code>fit_transform</code>.</li>
<li>If you run the <code>transform</code> method, all steps run <code>transform</code>.</li>
<li>If you run the <code>fit</code> method, all steps before the final one run <code>fit_transform</code>, and the final step runs <code>fit</code>.</li>
</ul>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Pipeline ends in a transformer:</strong></p>
<ul>
<li><strong><code>fit_transform</code>:</strong>
<ul>
<li>All steps run <code>fit_transform</code></li>
</ul></li>
<li><strong><code>transform</code>:</strong>
<ul>
<li>All steps run <code>transform</code></li>
</ul></li>
<li><strong><code>fit</code>:</strong>
<ul>
<li>All steps before the final step run <code>fit_transform</code></li>
<li>Final step runs <code>fit</code></li>
</ul></li>
</ul>
</div>
</div>
</div>
<p>Although this is a lot of information to take in, developing this level of understanding will definitely make it easier for you to test and debug your future <code>Pipeline</code>s.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/mlbook\.dataschool\.io");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
            // default icon
            link.classList.add("external");
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./ch07.html" class="pagination-link" aria-label="Handling missing values">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Handling missing values</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./ch09.html" class="pagination-link" aria-label="Workflow review #2">
        <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Workflow review #2</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright 2025, Kevin Markham. All Rights Reserved.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>