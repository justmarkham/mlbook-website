<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.29">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Kevin Markham">
<meta name="description" content="A practical guide to help you transform from Machine Learning novice to skilled Machine Learning practitioner.">

<title>7&nbsp; Handling missing values – Master Machine Learning with scikit-learn</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./ch08.html" rel="next">
<link href="./ch06.html" rel="prev">
<link href="./cover.jpg" rel="icon" type="image/jpeg">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-0815c480559380816a4d1ea211a47e91.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-e32d5626311174d9f6538aca58dc36c7.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://cdn.usefathom.com/script.js" data-site="AWKMQOCB" defer=""></script>


<meta property="og:title" content="7&nbsp; Handling missing values – Master Machine Learning with scikit-learn">
<meta property="og:description" content="">
<meta property="og:image" content="https://mlbook.dataschool.io/cover.jpg">
<meta property="og:site_name" content="Master Machine Learning with scikit-learn">
<meta name="twitter:title" content="7&nbsp; Handling missing values – Master Machine Learning with scikit-learn">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://mlbook.dataschool.io/cover.jpg">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./ch07.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Handling missing values</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Master Machine Learning with scikit-learn</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About this book</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Review of the Machine Learning workflow</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Encoding categorical features</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Improving your workflow with ColumnTransformer and Pipeline</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Workflow review #1</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Encoding text data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch07.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Handling missing values</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch08.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Fixing common workflow problems</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Workflow review #2</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Evaluating and tuning a Pipeline</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Comparing linear and non-linear models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Ensembling multiple models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch13.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Feature selection</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch14.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Feature standardization</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch15.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Feature engineering with custom transformers</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch16.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Workflow review #3</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch17.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">High-cardinality categorical features</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch18.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Class imbalance</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch19.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Class imbalance walkthrough</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch20.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Going further</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction-to-missing-values" id="toc-introduction-to-missing-values" class="nav-link active" data-scroll-target="#introduction-to-missing-values"><span class="header-section-number">7.1</span> Introduction to missing values</a></li>
  <li><a href="#three-ways-to-handle-missing-values" id="toc-three-ways-to-handle-missing-values" class="nav-link" data-scroll-target="#three-ways-to-handle-missing-values"><span class="header-section-number">7.2</span> Three ways to handle missing values</a></li>
  <li><a href="#missing-value-imputation" id="toc-missing-value-imputation" class="nav-link" data-scroll-target="#missing-value-imputation"><span class="header-section-number">7.3</span> Missing value imputation</a></li>
  <li><a href="#sec-7-4" id="toc-sec-7-4" class="nav-link" data-scroll-target="#sec-7-4"><span class="header-section-number">7.4</span> Using “missingness” as a feature</a></li>
  <li><a href="#qa-how-do-i-perform-multivariate-imputation" id="toc-qa-how-do-i-perform-multivariate-imputation" class="nav-link" data-scroll-target="#qa-how-do-i-perform-multivariate-imputation"><span class="header-section-number">7.5</span> Q&amp;A: How do I perform multivariate imputation?</a></li>
  <li><a href="#qa-what-are-the-best-practices-for-missing-value-imputation" id="toc-qa-what-are-the-best-practices-for-missing-value-imputation" class="nav-link" data-scroll-target="#qa-what-are-the-best-practices-for-missing-value-imputation"><span class="header-section-number">7.6</span> Q&amp;A: What are the best practices for missing value imputation?</a></li>
  <li><a href="#qa-whats-the-difference-between-columntransformer-and-featureunion" id="toc-qa-whats-the-difference-between-columntransformer-and-featureunion" class="nav-link" data-scroll-target="#qa-whats-the-difference-between-columntransformer-and-featureunion"><span class="header-section-number">7.7</span> Q&amp;A: What’s the difference between ColumnTransformer and FeatureUnion?</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Handling missing values</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduction-to-missing-values" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="introduction-to-missing-values"><span class="header-section-number">7.1</span> Introduction to missing values</h2>
<p>In this chapter, we’re going to deal with an issue that is common in real datasets, namely missing values.</p>
<p>A missing value is simply a value that does not exist in the dataset. It might be missing because that value purposefully wasn’t collected for that sample, or it might be missing due to an error in the data collection process.</p>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Common sources of missing values:</strong></p>
<ul>
<li>Value purposefully wasn’t collected</li>
<li>Error in the data collection process</li>
</ul>
</div>
</div>
</div>
<p>Let’s see an example in the Titanic dataset. We want to use Age as a feature, but notice that it has a missing value in row 5, encoded as <code>NaN</code>. This stands for “not a number”, and it’s how missing values are typically encoded in a pandas DataFrame.</p>
<div id="8a8c6202" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Survived</th>
<th data-quarto-table-cell-role="th">Pclass</th>
<th data-quarto-table-cell-role="th">Name</th>
<th data-quarto-table-cell-role="th">Sex</th>
<th data-quarto-table-cell-role="th">Age</th>
<th data-quarto-table-cell-role="th">SibSp</th>
<th data-quarto-table-cell-role="th">Parch</th>
<th data-quarto-table-cell-role="th">Ticket</th>
<th data-quarto-table-cell-role="th">Fare</th>
<th data-quarto-table-cell-role="th">Cabin</th>
<th data-quarto-table-cell-role="th">Embarked</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>3</td>
<td>Braund, Mr. Owen Harris</td>
<td>male</td>
<td>22.0</td>
<td>1</td>
<td>0</td>
<td>A/5 21171</td>
<td>7.2500</td>
<td>NaN</td>
<td>S</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1</td>
<td>1</td>
<td>Cumings, Mrs. John Bradley (Florence Briggs Th...</td>
<td>female</td>
<td>38.0</td>
<td>1</td>
<td>0</td>
<td>PC 17599</td>
<td>71.2833</td>
<td>C85</td>
<td>C</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1</td>
<td>3</td>
<td>Heikkinen, Miss. Laina</td>
<td>female</td>
<td>26.0</td>
<td>0</td>
<td>0</td>
<td>STON/O2. 3101282</td>
<td>7.9250</td>
<td>NaN</td>
<td>S</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>1</td>
<td>1</td>
<td>Futrelle, Mrs. Jacques Heath (Lily May Peel)</td>
<td>female</td>
<td>35.0</td>
<td>1</td>
<td>0</td>
<td>113803</td>
<td>53.1000</td>
<td>C123</td>
<td>S</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0</td>
<td>3</td>
<td>Allen, Mr. William Henry</td>
<td>male</td>
<td>35.0</td>
<td>0</td>
<td>0</td>
<td>373450</td>
<td>8.0500</td>
<td>NaN</td>
<td>S</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>0</td>
<td>3</td>
<td>Moran, Mr. James</td>
<td>male</td>
<td>NaN</td>
<td>0</td>
<td>0</td>
<td>330877</td>
<td>8.4583</td>
<td>NaN</td>
<td>Q</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>0</td>
<td>1</td>
<td>McCarthy, Mr. Timothy J</td>
<td>male</td>
<td>54.0</td>
<td>0</td>
<td>0</td>
<td>17463</td>
<td>51.8625</td>
<td>E46</td>
<td>S</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>0</td>
<td>3</td>
<td>Palsson, Master. Gosta Leonard</td>
<td>male</td>
<td>2.0</td>
<td>3</td>
<td>1</td>
<td>349909</td>
<td>21.0750</td>
<td>NaN</td>
<td>S</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>1</td>
<td>3</td>
<td>Johnson, Mrs. Oscar W (Elisabeth Vilhelmina Berg)</td>
<td>female</td>
<td>27.0</td>
<td>0</td>
<td>2</td>
<td>347742</td>
<td>11.1333</td>
<td>NaN</td>
<td>S</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>1</td>
<td>2</td>
<td>Nasser, Mrs. Nicholas (Adele Achem)</td>
<td>female</td>
<td>14.0</td>
<td>1</td>
<td>0</td>
<td>237736</td>
<td>30.0708</td>
<td>NaN</td>
<td>C</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>When we use the phrase “missing values”, we’re talking about <code>NaN</code>s only. It does not refer to categories or words in new data that weren’t seen during training. For example, if our new data contained the value “Z” in the Embarked column, that is not called a “missing value”, rather that’s called “an unknown category” or “a category you didn’t see during training”.</p>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Missing values vs unknown categories:</strong></p>
<ul>
<li><strong>Missing value:</strong> Value encoded as <code>NaN</code></li>
<li><strong>Unknown category:</strong> Category not seen in the training data</li>
</ul>
</div>
</div>
</div>
<p>To start our exploration of this topic, let’s see what happens if we try to add the Age column to our model.</p>
<p>First, we’ll add Age to the <code>cols</code> list and use that to modify the <code>X</code> DataFrame. Again, notice the missing value in Age.</p>
<div id="d04d2e26" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>cols <span class="op">=</span> [<span class="st">'Parch'</span>, <span class="st">'Fare'</span>, <span class="st">'Embarked'</span>, <span class="st">'Sex'</span>, <span class="st">'Name'</span>, <span class="st">'Age'</span>]</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> df[cols]</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>X</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Parch</th>
<th data-quarto-table-cell-role="th">Fare</th>
<th data-quarto-table-cell-role="th">Embarked</th>
<th data-quarto-table-cell-role="th">Sex</th>
<th data-quarto-table-cell-role="th">Name</th>
<th data-quarto-table-cell-role="th">Age</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>7.2500</td>
<td>S</td>
<td>male</td>
<td>Braund, Mr. Owen Harris</td>
<td>22.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0</td>
<td>71.2833</td>
<td>C</td>
<td>female</td>
<td>Cumings, Mrs. John Bradley (Florence Briggs Th...</td>
<td>38.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0</td>
<td>7.9250</td>
<td>S</td>
<td>female</td>
<td>Heikkinen, Miss. Laina</td>
<td>26.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0</td>
<td>53.1000</td>
<td>S</td>
<td>female</td>
<td>Futrelle, Mrs. Jacques Heath (Lily May Peel)</td>
<td>35.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0</td>
<td>8.0500</td>
<td>S</td>
<td>male</td>
<td>Allen, Mr. William Henry</td>
<td>35.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>0</td>
<td>8.4583</td>
<td>Q</td>
<td>male</td>
<td>Moran, Mr. James</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>0</td>
<td>51.8625</td>
<td>S</td>
<td>male</td>
<td>McCarthy, Mr. Timothy J</td>
<td>54.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>1</td>
<td>21.0750</td>
<td>S</td>
<td>male</td>
<td>Palsson, Master. Gosta Leonard</td>
<td>2.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>2</td>
<td>11.1333</td>
<td>S</td>
<td>female</td>
<td>Johnson, Mrs. Oscar W (Elisabeth Vilhelmina Berg)</td>
<td>27.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>0</td>
<td>30.0708</td>
<td>C</td>
<td>female</td>
<td>Nasser, Mrs. Nicholas (Adele Achem)</td>
<td>14.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Then, we’ll add Age to the <code>ColumnTransformer</code> as a passthrough column.</p>
<div id="bc739bb6" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>ct <span class="op">=</span> make_column_transformer(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    (ohe, [<span class="st">'Embarked'</span>, <span class="st">'Sex'</span>]),</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    (vect, <span class="st">'Name'</span>),</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'passthrough'</span>, [<span class="st">'Parch'</span>, <span class="st">'Fare'</span>, <span class="st">'Age'</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll update the <code>Pipeline</code> to include the modified <code>ColumnTransformer</code>.</p>
<div id="514b78de" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>pipe <span class="op">=</span> make_pipeline(ct, logreg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we’ll attempt to fit the <code>Pipeline</code>, but it throws an error due to the presence of a missing value.</p>
<div id="604ee3df" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>pipe.fit(X, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="d7c92768" class="cell" data-execution_count="13">
<div class="cell-output cell-output-stdout">
<pre><code>ValueError: Input contains NaN</code></pre>
</div>
</div>
<p>In general, scikit-learn models don’t accept data with missing values, with the exception of histogram-based gradient boosting trees. As such, we’ll need to figure out a way to handle the missing value if we want to include Age as a feature in our model.</p>
</section>
<section id="three-ways-to-handle-missing-values" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="three-ways-to-handle-missing-values"><span class="header-section-number">7.2</span> Three ways to handle missing values</h2>
<p>Let’s talk about three different ways we can handle missing values in our dataset.</p>
<p>The first way is to drop any rows from the DataFrame that have missing values. We can use the <code>dropna</code> method in pandas to experiment with this, and you’ll notice that row 5 is now gone. (Note that you would also need to drop the same row from <code>y</code>.)</p>
<div id="da6f9b50" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>X.dropna()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Parch</th>
<th data-quarto-table-cell-role="th">Fare</th>
<th data-quarto-table-cell-role="th">Embarked</th>
<th data-quarto-table-cell-role="th">Sex</th>
<th data-quarto-table-cell-role="th">Name</th>
<th data-quarto-table-cell-role="th">Age</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>7.2500</td>
<td>S</td>
<td>male</td>
<td>Braund, Mr. Owen Harris</td>
<td>22.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0</td>
<td>71.2833</td>
<td>C</td>
<td>female</td>
<td>Cumings, Mrs. John Bradley (Florence Briggs Th...</td>
<td>38.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0</td>
<td>7.9250</td>
<td>S</td>
<td>female</td>
<td>Heikkinen, Miss. Laina</td>
<td>26.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0</td>
<td>53.1000</td>
<td>S</td>
<td>female</td>
<td>Futrelle, Mrs. Jacques Heath (Lily May Peel)</td>
<td>35.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0</td>
<td>8.0500</td>
<td>S</td>
<td>male</td>
<td>Allen, Mr. William Henry</td>
<td>35.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">6</td>
<td>0</td>
<td>51.8625</td>
<td>S</td>
<td>male</td>
<td>McCarthy, Mr. Timothy J</td>
<td>54.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">7</td>
<td>1</td>
<td>21.0750</td>
<td>S</td>
<td>male</td>
<td>Palsson, Master. Gosta Leonard</td>
<td>2.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">8</td>
<td>2</td>
<td>11.1333</td>
<td>S</td>
<td>female</td>
<td>Johnson, Mrs. Oscar W (Elisabeth Vilhelmina Berg)</td>
<td>27.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9</td>
<td>0</td>
<td>30.0708</td>
<td>C</td>
<td>female</td>
<td>Nasser, Mrs. Nicholas (Adele Achem)</td>
<td>14.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>However, there are three main problems with this approach:</p>
<ul>
<li>First, if a high proportion of your rows have missing values, then this approach is impractical because it will discard too much of your training data.</li>
<li>Second, if there’s a useful pattern in the “missingness”, then dropping the rows will obscure this pattern.</li>
<li>Third, this takes care of the training data, but it doesn’t help you deal with missing values that might appear in new data.</li>
</ul>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Approach 1: Drop rows with missing values</strong></p>
<ul>
<li>May discard too much training data</li>
<li>May obscure a pattern in the “missingness”</li>
<li>Doesn’t help you with new data</li>
</ul>
</div>
</div>
</div>
<p>A second option for handling missing values is to drop any columns that have missing values. Again, we can use the <code>dropna</code> method to do this if we set the <code>axis</code> parameter to <code>'columns'</code>. You can see that row 5 is back, but the Age column is now gone.</p>
<div id="a8a22794" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>X.dropna(axis<span class="op">=</span><span class="st">'columns'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Parch</th>
<th data-quarto-table-cell-role="th">Fare</th>
<th data-quarto-table-cell-role="th">Embarked</th>
<th data-quarto-table-cell-role="th">Sex</th>
<th data-quarto-table-cell-role="th">Name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>7.2500</td>
<td>S</td>
<td>male</td>
<td>Braund, Mr. Owen Harris</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0</td>
<td>71.2833</td>
<td>C</td>
<td>female</td>
<td>Cumings, Mrs. John Bradley (Florence Briggs Th...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0</td>
<td>7.9250</td>
<td>S</td>
<td>female</td>
<td>Heikkinen, Miss. Laina</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0</td>
<td>53.1000</td>
<td>S</td>
<td>female</td>
<td>Futrelle, Mrs. Jacques Heath (Lily May Peel)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0</td>
<td>8.0500</td>
<td>S</td>
<td>male</td>
<td>Allen, Mr. William Henry</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>0</td>
<td>8.4583</td>
<td>Q</td>
<td>male</td>
<td>Moran, Mr. James</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>0</td>
<td>51.8625</td>
<td>S</td>
<td>male</td>
<td>McCarthy, Mr. Timothy J</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>1</td>
<td>21.0750</td>
<td>S</td>
<td>male</td>
<td>Palsson, Master. Gosta Leonard</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>2</td>
<td>11.1333</td>
<td>S</td>
<td>female</td>
<td>Johnson, Mrs. Oscar W (Elisabeth Vilhelmina Berg)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>0</td>
<td>30.0708</td>
<td>C</td>
<td>female</td>
<td>Nasser, Mrs. Nicholas (Adele Achem)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The main problem with this approach is that you’re discarding a feature that may be useful to your model.</p>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Approach 2: Drop columns with missing values</strong></p>
<ul>
<li>May discard useful features</li>
</ul>
</div>
</div>
</div>
<p>A third option for handling missing values is to impute missing values. Imputation means that you’re filling in missing values based on what you know from the non-missing data. Before proceeding with imputation, it’s important to carefully consider its costs and benefits:</p>
<ul>
<li>The benefit is that you’re able to keep more samples and features in your dataset, which may help to improve your model.</li>
<li>The cost is that you’re inserting values that may not match the true, unknown values, which may make your model less reliable.</li>
</ul>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Approach 3: Impute missing values</strong></p>
<ul>
<li><strong>Benefit:</strong> Keeps more samples and features</li>
<li><strong>Cost:</strong> Imputed values may not match the true values</li>
</ul>
</div>
</div>
</div>
<p>When making this decision, here are some useful factors to consider:</p>
<ul>
<li>How important are the particular samples that imputation would allow you to keep?</li>
<li>How important are the particular features that imputation would allow you to keep?</li>
<li>What percentage of the values in a feature would need to be imputed?</li>
<li>Are there samples or features without missing values that are highly correlated with the samples or features with missing values, such that the model wouldn’t be negatively affected by dropping those samples or features?</li>
<li>Is the missingness random, or is there a useful pattern in the missingness that would be lost if those samples or features were dropped?</li>
</ul>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Factors to consider before imputing:</strong></p>
<ul>
<li>How important are the samples?</li>
<li>How important are the features?</li>
<li>What percentage of values would need to be imputed?</li>
<li>Are there other samples or features that contain the same information?</li>
<li>Is the missingness random?</li>
</ul>
</div>
</div>
</div>
<p>Imputation is a complex topic, and ultimately I can’t tell you whether you should impute missing values in your particular situation. Instead, I’m going to show you how to do imputation in scikit-learn, and you can decide whether or not to do it. As well, I’ll provide some advice for imputation in lesson 7.6.</p>
</section>
<section id="missing-value-imputation" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="missing-value-imputation"><span class="header-section-number">7.3</span> Missing value imputation</h2>
<p>In this lesson, we’re going to perform missing value imputation on the Age column so that we can include it in our model. There are three different imputers that we can use in scikit-learn, but we’re going to start with <code>SimpleImputer</code> and then I’ll show you the others later in the chapter.</p>
<p>First, we’ll import <code>SimpleImputer</code> from the <code>impute</code> module and create an instance called <code>imp</code>.</p>
<div id="b519cae3" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>imp <span class="op">=</span> SimpleImputer()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we’ll pass the Age column to the <code>fit_transform</code> method to perform the imputation. Note that <code>SimpleImputer</code>, like most transformers, requires 2-dimensional input, which is why there are double brackets around Age.</p>
<div id="1dbb7894" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>imp.fit_transform(X[[<span class="st">'Age'</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>array([[22.        ],
       [38.        ],
       [26.        ],
       [35.        ],
       [35.        ],
       [28.11111111],
       [54.        ],
       [ 2.        ],
       [27.        ],
       [14.        ]])</code></pre>
</div>
</div>
<p>By default, <code>SimpleImputer</code> fills any missing values with the mean of the non-missing values, which is 28.11 in this case. It also supports other imputation strategies, namely the median value, the most frequent value, and a user-defined value. Note that all of these strategies can be applied to numeric features, but only the most frequent and user-defined strategies can be applied to categorical features.</p>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Simple imputation strategies:</strong></p>
<ul>
<li>Mean value</li>
<li>Median value</li>
<li>Most frequent value</li>
<li>User-defined value</li>
</ul>
</div>
</div>
</div>
<p>In order to check what value was imputed, we can examine the <code>statistics_</code> attribute, which was learned from the data during the fit step.</p>
<div id="0a81e841" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>imp.statistics_</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>array([28.11111111])</code></pre>
</div>
</div>
<p>Now that we know how <code>SimpleImputer</code> works, we’ll update the <code>ColumnTransformer</code> to include imputation of the Age column. As a reminder, brackets are required around Age because <code>SimpleImputer</code> expects 2-dimensional input, whereas brackets are not allowed around Name because <code>CountVectorizer</code> expects 1-dimensional input.</p>
<div id="34e7b628" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>ct <span class="op">=</span> make_column_transformer(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    (ohe, [<span class="st">'Embarked'</span>, <span class="st">'Sex'</span>]),</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    (vect, <span class="st">'Name'</span>),</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    (imp, [<span class="st">'Age'</span>]),</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'passthrough'</span>, [<span class="st">'Parch'</span>, <span class="st">'Fare'</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll run the <code>fit_transform</code> method, and you can see that there are now 48 columns in the feature matrix, whereas in the last chapter there were 47.</p>
<div id="1d82a37d" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>ct.fit_transform(X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>&lt;10x48 sparse matrix of type '&lt;class 'numpy.float64'&gt;'
    with 88 stored elements in Compressed Sparse Row format&gt;</code></pre>
</div>
</div>
<p>Next, we’ll update the <code>Pipeline</code> to include the revised <code>ColumnTransformer</code>, and fit it on <code>X</code> and <code>y</code>. There’s no error this time because the one missing value in <code>X</code> was imputed.</p>
<div id="7de8702d" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>pipe <span class="op">=</span> make_pipeline(ct, logreg)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>pipe.fit(X, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<style>div.sk-top-container {color: black;background-color: white;}div.sk-toggleable {background-color: white;}label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.2em 0.3em;box-sizing: border-box;text-align: center;}div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}div.sk-estimator {font-family: monospace;background-color: #f0f8ff;margin: 0.25em 0.25em;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;}div.sk-estimator:hover {background-color: #d4ebff;}div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 2em;bottom: 0;left: 50%;}div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;}div.sk-item {z-index: 1;}div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;}div.sk-parallel-item {display: flex;flex-direction: column;position: relative;background-color: white;}div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}div.sk-parallel-item:only-child::after {width: 0;}div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0.2em;box-sizing: border-box;padding-bottom: 0.1em;background-color: white;position: relative;}div.sk-label label {font-family: monospace;font-weight: bold;background-color: white;display: inline-block;line-height: 1.2em;}div.sk-label-container {position: relative;z-index: 2;text-align: center;}div.sk-container {display: inline-block;position: relative;}</style><div class="sk-top-container"><div class="sk-container"><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="ff1ef57e-9dfa-4efa-9603-ef32b5dca81b" type="checkbox"><label class="sk-toggleable__label" for="ff1ef57e-9dfa-4efa-9603-ef32b5dca81b">Pipeline</label><div class="sk-toggleable__content"><pre>Pipeline(steps=[('columntransformer',
                 ColumnTransformer(transformers=[('onehotencoder',
                                                  OneHotEncoder(),
                                                  ['Embarked', 'Sex']),
                                                 ('countvectorizer',
                                                  CountVectorizer(), 'Name'),
                                                 ('simpleimputer',
                                                  SimpleImputer(), ['Age']),
                                                 ('passthrough', 'passthrough',
                                                  ['Parch', 'Fare'])])),
                ('logisticregression',
                 LogisticRegression(random_state=1, solver='liblinear'))])</pre></div></div></div><div class="sk-serial"><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="f9642225-f034-447b-ad25-705b01774bf3" type="checkbox"><label class="sk-toggleable__label" for="f9642225-f034-447b-ad25-705b01774bf3">columntransformer: ColumnTransformer</label><div class="sk-toggleable__content"><pre>ColumnTransformer(transformers=[('onehotencoder', OneHotEncoder(),
                                 ['Embarked', 'Sex']),
                                ('countvectorizer', CountVectorizer(), 'Name'),
                                ('simpleimputer', SimpleImputer(), ['Age']),
                                ('passthrough', 'passthrough',
                                 ['Parch', 'Fare'])])</pre></div></div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="377a47be-e3df-4947-959c-ebc9153f5a1b" type="checkbox"><label class="sk-toggleable__label" for="377a47be-e3df-4947-959c-ebc9153f5a1b">onehotencoder</label><div class="sk-toggleable__content"><pre>['Embarked', 'Sex']</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="dd4a5a10-67e0-41a2-868d-95be9700dd59" type="checkbox"><label class="sk-toggleable__label" for="dd4a5a10-67e0-41a2-868d-95be9700dd59">OneHotEncoder</label><div class="sk-toggleable__content"><pre>OneHotEncoder()</pre></div></div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="cc643758-81e0-4697-a2cb-926e952efe6a" type="checkbox"><label class="sk-toggleable__label" for="cc643758-81e0-4697-a2cb-926e952efe6a">countvectorizer</label><div class="sk-toggleable__content"><pre>Name</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="b6dad2e5-1013-436f-bb78-162f2ba461e0" type="checkbox"><label class="sk-toggleable__label" for="b6dad2e5-1013-436f-bb78-162f2ba461e0">CountVectorizer</label><div class="sk-toggleable__content"><pre>CountVectorizer()</pre></div></div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="b2bf35d8-8b9a-4a05-b06e-04486d4735c3" type="checkbox"><label class="sk-toggleable__label" for="b2bf35d8-8b9a-4a05-b06e-04486d4735c3">simpleimputer</label><div class="sk-toggleable__content"><pre>['Age']</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="7c0d3bec-ad58-4ce0-9e6d-5b5b93589b67" type="checkbox"><label class="sk-toggleable__label" for="7c0d3bec-ad58-4ce0-9e6d-5b5b93589b67">SimpleImputer</label><div class="sk-toggleable__content"><pre>SimpleImputer()</pre></div></div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="7396bf35-3f63-4cb3-b69f-78e5af7b95e2" type="checkbox"><label class="sk-toggleable__label" for="7396bf35-3f63-4cb3-b69f-78e5af7b95e2">passthrough</label><div class="sk-toggleable__content"><pre>['Parch', 'Fare']</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="c61e9205-08f8-4e08-af1f-59906608e580" type="checkbox"><label class="sk-toggleable__label" for="c61e9205-08f8-4e08-af1f-59906608e580">passthrough</label><div class="sk-toggleable__content"><pre>passthrough</pre></div></div></div></div></div></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="24b04695-0e0d-4bc0-ac10-d8b678b02ead" type="checkbox"><label class="sk-toggleable__label" for="24b04695-0e0d-4bc0-ac10-d8b678b02ead">LogisticRegression</label><div class="sk-toggleable__content"><pre>LogisticRegression(random_state=1, solver='liblinear')</pre></div></div></div></div></div></div></div>
</div>
</div>
<p>Before we make predictions, we’re going to examine the <code>Pipeline</code> to confirm the imputation value for Age that was learned from <code>X</code>:</p>
<ul>
<li>First, we access the <code>columntransformer</code> step of the <code>Pipeline</code> using the <code>named_steps</code> attribute.</li>
<li>Then, from that <code>Pipeline</code> step, we access the <code>simpleimputer</code> transformer using the <code>named_transformers_</code> attribute.</li>
<li>Finally, from that transformer, we access the <code>statistics_</code> attribute.</li>
</ul>
<p>This confirms what we saw previously, which is that the imputer learned a value of 28.11 from the Age column.</p>
<div id="ef078118" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>(pipe.named_steps[<span class="st">'columntransformer'</span>]</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>     .named_transformers_[<span class="st">'simpleimputer'</span>]</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>     .statistics_)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>array([28.11111111])</code></pre>
</div>
</div>
<p>Next, we’ll update the <code>X_new</code> DataFrame to use the same columns as <code>X</code>.</p>
<div id="2354d1de" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>X_new <span class="op">=</span> df_new[cols]</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>X_new</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Parch</th>
<th data-quarto-table-cell-role="th">Fare</th>
<th data-quarto-table-cell-role="th">Embarked</th>
<th data-quarto-table-cell-role="th">Sex</th>
<th data-quarto-table-cell-role="th">Name</th>
<th data-quarto-table-cell-role="th">Age</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>7.8292</td>
<td>Q</td>
<td>male</td>
<td>Kelly, Mr. James</td>
<td>34.5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0</td>
<td>7.0000</td>
<td>S</td>
<td>female</td>
<td>Wilkes, Mrs. James (Ellen Needs)</td>
<td>47.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0</td>
<td>9.6875</td>
<td>Q</td>
<td>male</td>
<td>Myles, Mr. Thomas Francis</td>
<td>62.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0</td>
<td>8.6625</td>
<td>S</td>
<td>male</td>
<td>Wirz, Mr. Albert</td>
<td>27.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>1</td>
<td>12.2875</td>
<td>S</td>
<td>female</td>
<td>Hirvonen, Mrs. Alexander (Helga E Lindqvist)</td>
<td>22.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>0</td>
<td>9.2250</td>
<td>S</td>
<td>male</td>
<td>Svensson, Mr. Johan Cervin</td>
<td>14.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>0</td>
<td>7.6292</td>
<td>Q</td>
<td>female</td>
<td>Connolly, Miss. Kate</td>
<td>30.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>1</td>
<td>29.0000</td>
<td>S</td>
<td>male</td>
<td>Caldwell, Mr. Albert Francis</td>
<td>26.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>0</td>
<td>7.2292</td>
<td>C</td>
<td>female</td>
<td>Abrahim, Mrs. Joseph (Sophie Halaut Easu)</td>
<td>18.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>0</td>
<td>24.1500</td>
<td>S</td>
<td>male</td>
<td>Davies, Mr. John Samuel</td>
<td>21.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Finally, we’ll use the fitted <code>Pipeline</code> to make predictions for <code>X_new</code>.</p>
<div id="c3b54433" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>pipe.predict(X_new)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>array([0, 0, 0, 0, 1, 0, 1, 0, 1, 0])</code></pre>
</div>
</div>
<p>With respect to imputation, it’s worth talking about exactly what happens during the predict step. Since <code>X_new</code> didn’t have any missing values in the Age column, then nothing got imputed during prediction.</p>
<p>But let’s pretend that <code>X_new</code> did have a missing value in Age. If that was the case, then the imputed value would have been the mean of Age in <code>X</code>, which is 28.11, not the mean of Age in <code>X_new</code>. This is critically important because a transformer is only allowed to learn from the training data, and then apply what it learned to both the training and new data.</p>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>What would have been imputed for Age in X_new?</strong></p>
<ul>
<li>Imputed value would be the mean of Age in <code>X</code>, not the mean of Age in <code>X_new</code></li>
<li>Transformer is only allowed to learn from the training data</li>
</ul>
</div>
</div>
</div>
<p>As we’ve already seen in this book, the <code>OneHotEncoder</code> learns its categories from the training data, the <code>CountVectorizer</code> learns its vocabulary from the training data, and similarly, the <code>SimpleImputer</code> learns its imputation value from the training data. This is the reason why we run <code>fit_transform</code> on the training data and <code>transform</code> (only) on the new data.</p>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>What do transformers learn from the training data?</strong></p>
<ul>
<li><strong><code>OneHotEncoder</code>:</strong> Learns categories</li>
<li><strong><code>CountVectorizer</code>:</strong> Learns vocabulary</li>
<li><strong><code>SimpleImputer</code>:</strong> Learns imputation value</li>
</ul>
</div>
</div>
</div>
<p>If you’re struggling with this concept, here’s another way of looking at it that might be helpful to you. Pretend that <code>X_new</code> only contained a single sample, and that sample had a missing Age value. If you passed that <code>X_new</code> to the <code>predict</code> method, it’s clear that scikit-learn has to look to the training data for the imputation value, since there would be no other Age values in <code>X_new</code> for it to examine.</p>
</section>
<section id="sec-7-4" class="level2" data-number="7.4">
<h2 data-number="7.4" class="anchored" data-anchor-id="sec-7-4"><span class="header-section-number">7.4</span> Using “missingness” as a feature</h2>
<p>When imputing missing values, it’s also possible to use “missingness” as a feature of its own.</p>
<p>Starting in scikit-learn version 0.21, we can set the <code>add_indicator</code> parameter to <code>True</code> when creating a <code>SimpleImputer</code>.</p>
<div id="fa8ad5eb" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>imp_indicator <span class="op">=</span> SimpleImputer(add_indicator<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then when we use <code>fit_transform</code>, a separate column known as a missing indicator is included in the output matrix, and it indicates the presence of missing values.</p>
<div id="a3e71545" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>imp_indicator.fit_transform(X[[<span class="st">'Age'</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>array([[22.        ,  0.        ],
       [38.        ,  0.        ],
       [26.        ,  0.        ],
       [35.        ,  0.        ],
       [35.        ,  0.        ],
       [28.11111111,  1.        ],
       [54.        ,  0.        ],
       [ 2.        ,  0.        ],
       [27.        ,  0.        ],
       [14.        ,  0.        ]])</code></pre>
</div>
</div>
<p>Adding a missing indicator is useful when the data is not missing at random, since there might be a relationship between the “missingness” and the target value.</p>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Why add a missing indicator?</strong></p>
<ul>
<li>Useful when the data is not missing at random</li>
<li>Can encode the relationship between “missingness” and the target value</li>
</ul>
</div>
</div>
</div>
<p>For example, if Age was missing for some samples because older passengers declined to give their ages, and older passengers are more likely to have survived, then there is a relationship between Age being missing and the likelihood of survival. Thus the missingness itself can be a useful feature, and we can include that feature in the model using a missing indicator.</p>
<p>We’re not going to modify our <code>Pipeline</code> to include a missing indicator at this time, but we’ll return to this concept later in the book.</p>
</section>
<section id="qa-how-do-i-perform-multivariate-imputation" class="level2" data-number="7.5">
<h2 data-number="7.5" class="anchored" data-anchor-id="qa-how-do-i-perform-multivariate-imputation"><span class="header-section-number">7.5</span> Q&amp;A: How do I perform multivariate imputation?</h2>
<p>So far in this chapter, we’ve used <code>SimpleImputer</code> for imputation. <code>SimpleImputer</code> does univariate imputation, which means that it only looks at the feature being imputed when deciding what values to impute. Thus when imputing missing values for Age, <code>SimpleImputer</code> only considers the values in the Age column.</p>
<p>However, there’s another type of imputation called multivariate imputation. The intuition of multivariate imputation is that it can be useful to take other features into account when deciding what values to impute.</p>
<p>For example, maybe a high Parch and a low Fare is common for kids. Thus if Age is missing for a row which has a high Parch and a low Fare, then you should impute a low Age rather than the mean of Age, which is what <code>SimpleImputer</code> would do.</p>
<p>Multivariate imputation is available in scikit-learn via the <code>IterativeImputer</code> and <code>KNNImputer</code> classes, and in this lesson I’ll explain how both of them work.</p>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Types of imputation:</strong></p>
<ul>
<li><strong>Univariate imputation:</strong> Only examines the feature being imputed
<ul>
<li><code>SimpleImputer</code></li>
</ul></li>
<li><strong>Multivariate imputation:</strong> Takes multiple features into account
<ul>
<li><code>IterativeImputer</code></li>
<li><code>KNNImputer</code></li>
</ul></li>
</ul>
</div>
</div>
</div>
<p><code>IterativeImputer</code> was introduced in scikit-learn version 0.21. It’s considered experimental, which means that the API and predictions may change in future versions. As such, scikit-learn will only allow you to import the <code>IterativeImputer</code> class from the <code>impute</code> module if you first import the <code>enable_iterative_imputer</code> function from the <code>experimental</code> module. This is scikit-learn’s way of requiring you to acknowledge that you’re using experimental functionality.</p>
<div id="aa758090" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.experimental <span class="im">import</span> enable_iterative_imputer</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> IterativeImputer</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we’ll create an instance of <code>IterativeImputer</code> called <code>imp_iterative</code>, and pass three columns from <code>X</code> to its <code>fit_transform</code> method: Parch, Fare, and Age. Parch and Fare don’t have any missing values, and Age has 1 missing value. You can see that 24.24 was imputed for the missing value of Age.</p>
<div id="89c4052a" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>imp_iterative <span class="op">=</span> IterativeImputer()</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>imp_iterative.fit_transform(X[[<span class="st">'Parch'</span>, <span class="st">'Fare'</span>, <span class="st">'Age'</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>array([[ 0.        ,  7.25      , 22.        ],
       [ 0.        , 71.2833    , 38.        ],
       [ 0.        ,  7.925     , 26.        ],
       [ 0.        , 53.1       , 35.        ],
       [ 0.        ,  8.05      , 35.        ],
       [ 0.        ,  8.4583    , 24.23702669],
       [ 0.        , 51.8625    , 54.        ],
       [ 1.        , 21.075     ,  2.        ],
       [ 2.        , 11.1333    , 27.        ],
       [ 0.        , 30.0708    , 14.        ]])</code></pre>
</div>
</div>
<p>Here’s how the <code>IterativeImputer</code> works:</p>
<ol type="1">
<li>For the 9 rows in which Age is not missing, scikit-learn trains a regression model in which Parch and Fare are the features and Age is the target.</li>
<li>For the 1 row in which Age is missing, scikit-learn passes the Parch and Fare values to the trained model. The model makes a prediction for Age, and that value is used for imputation.</li>
</ol>
<p>In summary, <code>IterativeImputer</code> turned this into a regression problem with 2 features, 9 samples of training data, and 1 sample of new data.</p>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>How IterativeImputer works:</strong></p>
<ol type="1">
<li><strong>Age not missing:</strong> Train a regression model to predict Age using Parch and Fare</li>
<li><strong>Age missing:</strong> Predict Age using trained model</li>
</ol>
</div>
</div>
</div>
<p>There are four things I want to comment on about <code>IterativeImputer</code>:</p>
<ul>
<li>First, it only works with numerical features. This is unlike <code>SimpleImputer</code>, which also works with categorical features.</li>
<li>Second, you have to decide which features to pass to <code>IterativeImputer</code>. My advice is to use features that you believe are highly correlated with one another.</li>
<li>Third, you are allowed to pass it multiple features with missing values. In other words, Parch, Fare, and Age could all have missing values. <code>IterativeImputer</code> will just do three different regression problems, and each column will take a turn being the target.</li>
<li>Fourth, you can actually choose which model <code>IterativeImputer</code> uses for the regression problem. By default, it uses Bayesian ridge regression.</li>
</ul>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Notes about IterativeImputer:</strong></p>
<ul>
<li>Only works with numerical features</li>
<li>You have to decide which features to include</li>
<li>You can include multiple features with missing values</li>
<li>You can choose the regression model</li>
</ul>
</div>
</div>
</div>
<p>Anyway, if you decided you wanted to include it in the <code>ColumnTransformer</code>, you would just specify that Parch, Fare, and Age should be transformed by <code>imp_iterative</code>, and thus there would no longer be any passthrough columns.</p>
<div id="abc6eeee" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>ct <span class="op">=</span> make_column_transformer(</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    (ohe, [<span class="st">'Embarked'</span>, <span class="st">'Sex'</span>]),</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    (vect, <span class="st">'Name'</span>),</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    (imp_iterative, [<span class="st">'Parch'</span>, <span class="st">'Fare'</span>, <span class="st">'Age'</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our other option for multivariate imputation is <code>KNNImputer</code>, which was introduced in scikit-learn version 0.22 and is not considered experimental.</p>
<p>To use it, we’ll import it from the <code>impute</code> module, create an instance called <code>imp_knn</code>, and then pass the same three columns from <code>X</code> to the <code>fit_transform</code> method. This time, you’ll see that 30.5 was imputed for the missing value of Age.</p>
<div id="31de2096" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> KNNImputer</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>imp_knn <span class="op">=</span> KNNImputer(n_neighbors<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>imp_knn.fit_transform(X[[<span class="st">'Parch'</span>, <span class="st">'Fare'</span>, <span class="st">'Age'</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>array([[ 0.    ,  7.25  , 22.    ],
       [ 0.    , 71.2833, 38.    ],
       [ 0.    ,  7.925 , 26.    ],
       [ 0.    , 53.1   , 35.    ],
       [ 0.    ,  8.05  , 35.    ],
       [ 0.    ,  8.4583, 30.5   ],
       [ 0.    , 51.8625, 54.    ],
       [ 1.    , 21.075 ,  2.    ],
       [ 2.    , 11.1333, 27.    ],
       [ 0.    , 30.0708, 14.    ]])</code></pre>
</div>
</div>
<p>Here’s how the <code>KNNImputer</code> works:</p>
<ol type="1">
<li>First, <code>KNNImputer</code> finds the row in which Age is missing.</li>
<li>Because I set the <code>n_neighbors</code> parameter to 2, scikit-learn finds the 2 nearest rows in which Age is not missing, measured by how close the Parch and Fare values are to this row. In this case, the third and the fifth rows are the two nearest rows.</li>
<li>Finally, scikit-learn calculates the mean of the Age values from those 2 rows. In this case, it takes the mean of 26 and 35 which is 30.5, and that value is used as the imputation value.</li>
</ol>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>How KNNImputer works:</strong></p>
<ol type="1">
<li>Find the row in which Age is missing</li>
<li>Find the <code>n_neighbors</code> nearest rows in which Age is not missing</li>
<li>Calculate the mean of Age from the nearest rows</li>
</ol>
</div>
</div>
</div>
<p>You might be wondering how you should choose the value for <code>n_neighbors</code>. As you’ll see later in the book, transformer hyperparameters like this should be chosen through a tuning process in the same way that you would tune the hyperparameters for a model.</p>
</section>
<section id="qa-what-are-the-best-practices-for-missing-value-imputation" class="level2" data-number="7.6">
<h2 data-number="7.6" class="anchored" data-anchor-id="qa-what-are-the-best-practices-for-missing-value-imputation"><span class="header-section-number">7.6</span> Q&amp;A: What are the best practices for missing value imputation?</h2>
<p>Missing value imputation may be considered dubious from a statistics point of view, but if your primary goal is prediction, then imputation has been shown experimentally to work well under certain conditions.</p>
<p>In this lesson, I’m going to summarize what I’ve learned from research papers about the best practices for effective missing value imputation.</p>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Types of missing data:</strong></p>
<ul>
<li><strong>Missing Completely At Random (MCAR):</strong>
<ul>
<li>No relationship between missingness and underlying data</li>
<li><strong>Example:</strong> Booking agent forgot to gather Age</li>
</ul></li>
<li><strong>Missing Not At Random (MNAR):</strong>
<ul>
<li>Relationship between missingness and underlying data</li>
<li><strong>Example:</strong> Older passengers declined to give their Age</li>
</ul></li>
<li><strong>Missing due to a structural deficiency:</strong>
<ul>
<li>Data omitted for a specific purpose</li>
<li><strong>Example:</strong> Staff members did not pay a Fare</li>
</ul></li>
</ul>
</div>
</div>
</div>
<p>The best practices actually differ depending upon the type of missing data you have, and so I’m going to start with the first type of missing data, which is known as Missing Completely At Random or “MCAR”. Missing data is designated as MCAR if there’s no relationship between the missingness and the underlying data.</p>
<p>An example of this would be if Age was missing because the booking agent forgot to gather that information from a few of the passengers. In other words, the data is just as likely to be missing for an older person as a younger person, and thus missingness is not meaningfully related to Age.</p>
<p>If you determine that your data is MCAR, here’s what the research indicates:</p>
<ul>
<li>If you have a small dataset, then <code>IterativeImputer</code> tends to be more effective than mean imputation.</li>
<li>If you have a large dataset, <code>IterativeImputer</code> and mean imputation tend to work equally well, though <code>IterativeImputer</code> will have a much higher computational cost.</li>
<li>There’s no benefit to adding a missing indicator since the missingness is random.</li>
</ul>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Advice for MCAR imputation:</strong></p>
<ul>
<li><strong>Small dataset:</strong> <code>IterativeImputer</code> is more effective than mean imputation</li>
<li><strong>Large dataset:</strong> <code>IterativeImputer</code> and mean imputation work equally well</li>
<li>No benefit to adding a missing indicator</li>
</ul>
</div>
</div>
</div>
<p>The next type of missing data is known as Missing Not At Random or “MNAR”. Missing data is designated as MNAR if there is a relationship between the missingness and the underlying data, which is commonly the case in real-world datasets.</p>
<p>I mentioned an example of this in a previous lesson, namely if Age was missing because some of the older passengers declined to give their ages. In other words, there is a relationship between missingness and Age.</p>
<p>If your data is MNAR, here’s what the research indicates:</p>
<ul>
<li>Mean imputation is more effective than <code>IterativeImputer</code> because <code>IterativeImputer</code> actually obscures the pattern that the model might otherwise be able to learn.</li>
<li>It’s important that you add a missing indicator so that the model can learn from the pattern of missingness.</li>
<li>It’s recommended to use a powerful, non-linear model for prediction, since mean imputation tends not to work as well in combination with a linear model.</li>
</ul>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Advice for MNAR imputation:</strong></p>
<ul>
<li>Mean imputation is more effective than <code>IterativeImputer</code></li>
<li>Add a missing indicator</li>
<li>Use a powerful, non-linear model for prediction</li>
</ul>
</div>
</div>
</div>
<p>The final type of missing data I’ll mention is data that’s missing due to a structural deficiency. This means that a value is missing because it was omitted for a specific purpose. An example of this would be if the passenger list included staff members, and their values for the Fare column were listed as missing to indicate that they did not pay a fare.</p>
<p>In the case of a structural deficiency, my advice is to impute the most logical and reasonable user-defined value, and also add a missing indicator. For the example I mentioned, it would make the most sense to insert a Fare value of 0 for all staff members.</p>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Advice for structural deficiency imputation:</strong></p>
<ul>
<li>Impute a logical and reasonable user-defined value</li>
<li>Add a missing indicator</li>
</ul>
</div>
</div>
</div>
<p>All of these examples should make clear that if you’re going to impute missing values, it’s important to thoroughly understand your data before choosing an imputation strategy.</p>
<p>Finally, it’s worth reiterating that histogram-based gradient boosting trees in scikit-learn have built-in support for missing values. In other words, you can pass it data with missing values, and it will handle them internally. This is significant because it has a lower computation cost than complex imputation strategies like <code>IterativeImputer</code>, and yet it can perform just as well or better than imputation across a variety of missing value scenarios.</p>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Advantages of histogram-based gradient boosting trees:</strong></p>
<ul>
<li>Built-in support for missing values</li>
<li>Lower computational cost than <code>IterativeImputer</code></li>
<li>Performs well across many missing value scenarios</li>
</ul>
</div>
</div>
</div>
<p>Therefore, if you have a large dataset with a lot of missing values, it’s worth trying out a histogram-based gradient boosting tree as your prediction model and excluding the imputation step, and comparing its performance with any other model that does require an imputation step.</p>
</section>
<section id="qa-whats-the-difference-between-columntransformer-and-featureunion" class="level2" data-number="7.7">
<h2 data-number="7.7" class="anchored" data-anchor-id="qa-whats-the-difference-between-columntransformer-and-featureunion"><span class="header-section-number">7.7</span> Q&amp;A: What’s the difference between ColumnTransformer and FeatureUnion?</h2>
<p>As we saw earlier in this chapter, you can add a missing indicator to the output of <code>SimpleImputer</code> by setting the <code>add_indicator</code> parameter to <code>True</code>.</p>
<div id="9d490e62" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>imp_indicator <span class="op">=</span> SimpleImputer(add_indicator<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>imp_indicator.fit_transform(X[[<span class="st">'Age'</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>array([[22.        ,  0.        ],
       [38.        ,  0.        ],
       [26.        ,  0.        ],
       [35.        ,  0.        ],
       [35.        ,  0.        ],
       [28.11111111,  1.        ],
       [54.        ,  0.        ],
       [ 2.        ,  0.        ],
       [27.        ,  0.        ],
       [14.        ,  0.        ]])</code></pre>
</div>
</div>
<p>In this lesson, we’re going to explore a different way to create this same matrix as a way of learning about the <code>FeatureUnion</code> class.</p>
<p>To create the left column of this matrix, we can use the <code>imp</code> object, which is a <code>SimpleImputer</code> without a missing indicator.</p>
<div id="0fde3a5a" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>imp.fit_transform(X[[<span class="st">'Age'</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<pre><code>array([[22.        ],
       [38.        ],
       [26.        ],
       [35.        ],
       [35.        ],
       [28.11111111],
       [54.        ],
       [ 2.        ],
       [27.        ],
       [14.        ]])</code></pre>
</div>
</div>
<p>To create the right column of the matrix, we can use the <code>MissingIndicator</code> class. We’ll import the class from the <code>impute</code> module and create an instance called <code>indicator</code>.</p>
<div id="e0f701c5" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> MissingIndicator</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>indicator <span class="op">=</span> MissingIndicator()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When we pass Age to the <code>fit_transform</code> method, it outputs <code>False</code> and <code>True</code> instead of 0 and 1, but otherwise the results are identical to the right column of the matrix.</p>
<div id="08fe2cec" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>indicator.fit_transform(X[[<span class="st">'Age'</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>array([[False],
       [False],
       [False],
       [False],
       [False],
       [ True],
       [False],
       [False],
       [False],
       [False]])</code></pre>
</div>
</div>
<p>The final step in recreating our original matrix is to stack these two columns side-by-side, which we can do by using the <code>FeatureUnion</code> class. A <code>FeatureUnion</code> applies multiple transformations to a single input column and stacks the results side-by-side.</p>
<p>We’ll import the <code>make_union</code> function from the <code>pipeline</code> module, and then create an instance called <code>union</code> that contains both the <code>imp</code> and <code>indicator</code> objects.</p>
<div id="6cc5a283" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> make_union</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>union <span class="op">=</span> make_union(imp, indicator)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When we pass Age to the <code>union</code>’s <code>fit_transform</code> method, it runs both the <code>imp</code> and <code>indicator</code> transformations and stacks the results side-by-side. Note that <code>False</code> and <code>True</code> are converted to 0 and 1 when included in a numeric array, and thus we’ve recreated our original matrix.</p>
<div id="68a05735" class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>union.fit_transform(X[[<span class="st">'Age'</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>array([[22.        ,  0.        ],
       [38.        ,  0.        ],
       [26.        ,  0.        ],
       [35.        ,  0.        ],
       [35.        ,  0.        ],
       [28.11111111,  1.        ],
       [54.        ,  0.        ],
       [ 2.        ,  0.        ],
       [27.        ,  0.        ],
       [14.        ,  0.        ]])</code></pre>
</div>
</div>
<p>Alternatively, we could have achieved the same results using a <code>ColumnTransformer</code>. Specifically, we could have passed the Age column to two separate transformations.</p>
<div id="51ff2fd0" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>ct <span class="op">=</span> make_column_transformer(</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    (imp, [<span class="st">'Age'</span>]),</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    (indicator, [<span class="st">'Age'</span>]))</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>ct.fit_transform(X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="45">
<pre><code>array([[22.        ,  0.        ],
       [38.        ,  0.        ],
       [26.        ,  0.        ],
       [35.        ,  0.        ],
       [35.        ,  0.        ],
       [28.11111111,  1.        ],
       [54.        ,  0.        ],
       [ 2.        ,  0.        ],
       [27.        ,  0.        ],
       [14.        ,  0.        ]])</code></pre>
</div>
</div>
<p>Stepping back, here’s a quick comparison between <code>FeatureUnion</code> and <code>ColumnTransformer</code>:</p>
<ul>
<li>A <code>FeatureUnion</code> works on a single input column, and applies multiple different transformations to that one column in parallel.</li>
<li>A <code>ColumnTransformer</code> works on multiple input columns, and applies a different transformation to each input column in parallel.</li>
</ul>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>FeatureUnion vs ColumnTransformer:</strong></p>
<ul>
<li><strong><code>FeatureUnion</code>:</strong>
<ul>
<li>Single input column</li>
<li>Applies multiple different transformations to that column in parallel</li>
</ul></li>
<li><strong><code>ColumnTransformer</code>:</strong>
<ul>
<li>Multiple input columns</li>
<li>Applies a different transformation to each column in parallel</li>
</ul></li>
</ul>
</div>
</div>
</div>
<p>You can see that <code>ColumnTransformer</code> is far more flexible than <code>FeatureUnion</code>, and so my recommendation is that you use <code>ColumnTransformer</code> to do all of your transformations. For the rare case in which you need to apply multiple different transformations in parallel to the same column, you can use either a <code>FeatureUnion</code> or a <code>ColumnTransformer</code>, depending upon which solution makes more sense to you.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/mlbook\.dataschool\.io");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
            // default icon
            link.classList.add("external");
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./ch06.html" class="pagination-link" aria-label="Encoding text data">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Encoding text data</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./ch08.html" class="pagination-link" aria-label="Fixing common workflow problems">
        <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Fixing common workflow problems</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright © 2026 by Kevin Markham. All rights reserved.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>